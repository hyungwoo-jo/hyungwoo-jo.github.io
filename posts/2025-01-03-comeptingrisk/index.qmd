---
title: "Competing Risk Analysis"
description: "Fine-Gray Method 공부 내용 정리"
image: img/image.png
categories: [statistics]
author:
  - name: Hyungwoo Jo
    url: https://github.com/sl-eeper
fig_width: 400
date: 2025-01-03
format: html
execute:
  freeze: true
draft: false
citation: true
---

# Competing Risk

경쟁 위험(Competing risk)은 한 종류의 이벤트가 발생하면 다른 이벤트가 발생할 수 없는 상황으로 정의됩니다다. 예를 들어, 암 재발이 event of interest 인 경우 사망이 competing risk로 작용할 수 있습니다 (사망한 암 환자에게는 암 재발이라는 event가 발생 할 수 없기 때문). 경쟁 위험을 무시하면 **모집단의 생존 함수**나 **이벤트 발생률**을 **과대 혹은 과소평가** 할 위험이 생기기에 이를 고려한 분석이 필요한 경우들이 있습니다. 예를 들어 고령에 암을 진단 받은 환자의 경우 사망이 competing risk로 강하게 작용하여 이를 다 censoring이 되었다고 고려할시 이벤트 발생률이 왜곡될 수 있기 때문입니다. 이를 고려한 분석에 대해 알아보기 위해 기초적인 생존 분석의 개념을 간략하게 살펴보고 넘어가겠습니다.

## 생존 함수

$$
S(t) = \prod_{i: t_i \leq t} \left(1 - \frac{d_i}{n_i}\right)
$$

-   S(t): 생존 함수\

-   $t_i$: 사건 발생 시점\

-   $d_i$: 시점 $t_i$에서 발생한 사건 수\

-   $n_i$: 시점 $t_i$에서 위험에 노출된 대상 수\

-   결국 **생존 함수란 각 사건 발생 시점에서의 생존 확률(어떤 이벤트도 발생하지 않을 확률)을 누적 곱하여 계산한 시간** $t$까지 생존할 확률을 뜻합니다.

## 위험 함수

$$
  \lambda_k(t) = \lim_{\Delta t \to 0} \frac{P(t \leq T < t + \Delta t, \epsilon = k \mid T \geq t)}{\Delta t}
  $$

-   $\lambda_k(t)$: 이벤트 유형 $k$의 원인별 위험 함수\

-   T: 이벤트 발생 시간\

-   $\epsilon$: 이벤트 유형 지표(Ex. $\epsilon$ = 1: event of interest, $\epsilon$ = 2: competing risk )

-   결국 **위험 함수란 각 시점에서 event k 가 발생할 확률**을 뜻합니다.

## 누적발생률 함수(CIF)

$$
F_k(t) = \int_{0}^{t} \lambda_k(u) S(u) \, du
$$

이벤트 k에 대한 **누적발생률 함수**란 결국 시점 마다 생존해 있을 확률 $S(t)$ 와 그 시점 에서 k가 발생할 위험 $\lambda_k(t)$를 곱하여 합산한 값으로, **시점 t에 이번트 k의 누적 발생률**을 뜻하게 됩니다. 여기서 생존 함수 S(t) 의 경우 직전 시점의 생존 확률인 S(t-1)과 시점 t에서 위험이 발생하지 않을 확률(1-$\lambda_1(t)$-$\lambda_2(t)$) 의 곱으로 계산됩니다.(만약 이벤트가 1,2인 경우)

## 왜 경쟁 위험 분석에서 CIF를 사용할까?

경쟁 위험이 없는 생존 분석에서는 대게 Kaplan-Meier 추정치를 사용하지만, 이는 앞서 말했던 예시와 같이 이벤트 발생률을 과대 혹은 과소 평가할 위험이 있기 때문에 경쟁 위험이 있는 경우 적합하지 않은 경우가 많습니다. 암 재발과 사망의 예시를 다시 생각해보겠습니다. Kaplan-Meier 추정치의 경우 사망한 환자의 경우 censoring 된 것으로 처리가 되어 "이 환자의 경우 이후 정보는 알 수 없다"고 간주를 하고 계산하는 추정치입니다. 하지만, 현실에서는 사망한 환자의 경우 이후 암 재발이 일어날 가능성이 0이라는 것을 알 수 있습니다. 반면 CIF의 경우 수식에서도 볼 수 있듯이 사망이 발생해버린 사람은 이미 사건이 발생한 상태로 처리가 되며, 경쟁 이벤트가 발생했다는 $F_2(t)$라는 누적발생률 함수에 따로 기록되고 있는 것을 알 수 있습니다.

# Competing Risk Analysis

## Gray's test

그렇다면 경쟁 위험이 있는 경우 분석(예를 들어 group A와 group B에서 사망을 고려한 암 재발 발생률의 차이)를 어떻게 할 수 있는지 알아보겠습니다. 두 그룹에서의 누적 발생률의 차이가 있는지를 알아보는 방법으로는 Gray's test가 있습니다.

Gray's test의 기본적인 개념은 사건이 발생한 고유의 시점마다 *Event of interest의 수*와 *모든 그룹이 동일하다고 가정했을 때 기대되는 사건 수*의 차이를 계산하고 그 값에 $(1-F(t-))^\rho$형태의 가중치(F는 누적함수)를 곱한 값들의 합을 보는 것입니다.($\rho$값의 경우 0일 때는 모든 시간대를 균등하게 반영(log-rank 스타일과 유사)하며, $\rho$값에 1과 같은 수치를 반영하면, CIF가 커지는 방식을 더 강조하는 등 설정에 따라 검정력에 영향을 줄 수 있습니다) 기대되는 사건 수의 경우 사건이 발생한 시점별로 ‘해당 시점 직전 위험 집단에서 그룹 i가 차지하는 비율’을 이용하여 “전체 사건 수”를 분배하는 방식으로 계산합니다. 만약 총 그룹이 G개라면 G-1개의 {(관찰)-(기대)}×가중치를 누적한 값을 얻게 되고 이를 점수 벡터 s로 합니다.

다만 관찰값과 기대값의 차이에 대한 단순합만 고려한다면 크기를 해석하기 어렵습니다. 각 시점마다 발생하는 사건 수, 그룹 간 분포가 시간이 지날 수록 달라지기 때문에 **불확실성(분산)**이 누적됩니다. 따라서 각 시점에서의 차이가 가지는 변동성을 추적하여, 전체 시간축에서 얻은 **점수 s의 분산-공분산 행렬 V**를 계산합니다. 이후 $Z = s^{T} V^{-1} s$를 계산하여 카이제곱 분포를 따르는 검정 통계량과 자유도 G-1을 얻을 수 있습니다. 이후 $p\text{-value} = 1 - \chi^2_{\text{cdf}}(Z; \, df = G - 1)$ 를 통해 p-value를 얻을 수 있습니다.

즉 Gray's test는 여러 그룹의 누적발생함수가 같은지를 살펴보는 비모수적인 접근이며, CIF가 시간에 대해 어떤 형태(ex. 지수함수)를 가진다는 식의 구체적 모형을 가정하지 않는 다는 것을 알 수 있습니다. 다만, log-rank test와 마찬가지로 CIF 그래프간의 교차가 빈번하거나 차이가 특정 시간대에 국한되어 있다면 검정력이 떨어질 수 있으며 CIF 곡선의 모형에 따른 $\rho$값의 조정을 통해 연구자가 검정하고자 하는 바를 조절할 수 있겠습니다.

Gray's test를 통한 p value는 다음과 같이 R에서 계산할 수 있습니다. R의 survival 라이브러리에서 제공되는 mgus2 데이터 셋을 받은 이후 pstat이 0인경우(즉 이벤트가 발생하지 않고 관찰(censor)된 경우) etime을 futime(관찰기간)으로 그리고 이벤트가 발생한 경우 ptime(이벤트가 발생한 시간)으로 설정합니다. 이후 event의 경우 이벤트가 발생하지 않았는데 사망한 경우 2, 발생한 경우 1, 발생도 사망도 하지 않은 경우를 0으로 코딩합니다. 이후 cmprsk 패키지의 cuminc 함수를 사용하여 ftime, fstatus를 각각 etime과 event로 설정한 이후 성별에 따른 CIF의 차이에 대한 p value를 얻을 수 있습니다.

```{r, echo = TRUE}

library(survival);library(cmprsk)
data<-mgus2
data$etime <- with(data, ifelse(pstat==0, futime, ptime))
data$event <- with(data, ifelse(pstat==0, 2*death, 1))
data$event <- factor(data$event, 0:2)
ftime <- data$etime
fstatus <- data$event 
group <- data$sex 

cif_fit <- cuminc(ftime = ftime, fstatus = fstatus, group = group)

print(cif_fit$Tests)

```

결과는 다음과 같이 해석할 수 있습니다. 첫 줄의 경우 1(이 경우 pstat의 발생-다발성 골수종으로의 진행: Event of Interest)에 대한 Z값, p value, 자유도이고, 두번째 줄의 경우 2(이경우 사망: Competing risk)에 대한 Z값, p value, 자유도입니다. 따라서 성별에 따른 다발성골수종의 누적발생률은 통계학적으로 유의미하게 차이나지 않으며, 사망의 누적발생률은 통계학적으로 유의미하게 차이가 난다는 것을 알 수 있습니다.

## Fine-Gray Method

다만 의학연구의 경우 group A와 group B의 누적발생률 차이 외에도 공변량(ex. 치료군 vs 대조군, 나이 등)이 시간 전반에 걸쳐 일정하게 누적발생함수에 어떤 배수를 주는지, 즉 hazard ratio가 필요한 경우가 많습니다. 경쟁 위험을 고려한 hazard ratio 값을 얻기 위해 Fine-Gray Method를 사용해볼 수 있습니다. Fine-Gray 모형의 경우 하위분포위험 함수를 회귀모형 형태로 표현해 공변량의 영향력을 추정하는 방법입니다.

Fine-Gray에서 하위 분포 위험의 경우 다음과 같이 정의됩니다. $$
\alpha_1(t)
\;=\;
-\,\frac{d}{dt} \,\ln\!\bigl\{1 - F_1(t)\bigr\}
\;=\;
\frac{f_1(t)}{\,1 - F_1(t)\,}.
$$

위와 같이, CIF 자체를 직접 회귀모형화 할 수 있는 것이 Fine-Gray 모형의 특징입니다. 

$$
\alpha_1\bigl(t \mid \mathbf{X}\bigr) 
\;=\; 
\alpha_{1,0}(t)\,\exp\!\bigl(\boldsymbol{\beta}^\top \mathbf{X}\bigr).
$$\

하위 분포 위험에 대해 X는 공변량 벡터이고 $\beta$는 공변량에 대응하는 회귀 계수로, 공변량 효과가 시간에 따라 일정배수로 작용한다는 **비례하위분포위험**을 가정하여 $\beta$을 추정하여 통상적으로 아는 hazard ratio 값을 추론할 수 있습니다. 
R에서 실행하는 코드를 한번 살펴보겠습니다. 

```{r, echo = TRUE}
pdata <- finegray(Surv(etime, event) ~ ., data=data)
head(pdata)
```
R의 survival 패키지에서 제공되는 finegray 함수를 사용하면 fine gray method를 사용하기 위한 데이터가 형성됩니다. 위 데이터를 살펴보면 id가 1인 사람은 time이 30일 떄 사망한 것을 알 수 있습니다. 이후에 finegray함수는 fgstart, fgstop, fgstatus, fgwt란 변수를 생성하여 환자가 사망하지 않았다면 number of risk에 기여할 수 있었을 가중치를 계산하여 fgwt란 가중치를 시간 구간마다 계산합니다. fgwt의 경우 관심 이벤트나 경쟁 이벤트가 발생하지 않은채 censoring으로 빠지지 않고 계속 관찰 중인 비율을 Kaplan-Meier estimate로 추정한 값들의 비율로 결정됩니다. 
따라서 시간이 지날 수록 censoring이 될 확률이 높아지기 때문에 fgwt 또한 시간이 지날 수록 감소한다는 것을 알 수 있습니다. 따라서 competing risk가 발생한 환자들에 대해서는 fgstatus는 0으로 변경하고, wt를 부여함으로서 fgstatus를 0과 1만 가지는 값으로 치환하여 데이터셋을 전통적 생존분석에 사용할 수 있도록 finegray함수를 바꿔줍니다. 이후 바뀐 데이터 셋을 통하여 평소의 cox와 같은 형태의 분석이 가능합니다.

```{r, echo = TRUE}
fgfit <- coxph(Surv(fgstart, fgstop, fgstatus) ~ age+sex,
               weight=fgwt, data=pdata, model = T)
summary(fgfit)
```



