---
title: "Causal Inference (2): Propensity Score Matching"
description: "ATE, ATT의 개념과 Propensity Score에 대해 알아보자"
image: img/image.jpg
categories: [statistics, causal-inference, R]
author:
  - name: Hyungwoo Jo
    url: https://github.com/hyungwoo-jo
fig_width: 400
date: 2026-01-02
format: html
execute:
  freeze: true
draft: false
citation: true
---

1편에서는 인과추론의 필요성을 역설했다. 2편에서는 실제 의학 연구에서 가장 빈번하게 마주치는 상황을 통해, **성향점수(Propensity Score)**를 이용한 다양한 분석 방법론(**PSM, IPTW**)이 어떻게 다른 결론을 도출하는지, 그리고 그 각각의 결론(**ATT, ATE**)이 어떤 의미를 갖는지 깊이 있게 파고들어 보자.

우리는 하나의 일관된 예시를 통해 이 여정을 떠날 것이다.

---

## 1. 시나리오: 심장판막 질환의 딜레마

당신은 심장내과 전문의다. 심장판막 질환 환자에게는 두 가지 선택지가 있다.

1.  **수술 (Surgery, $T=1$)**: 가슴을 여는 개흉 수술. 효과는 확실하지만 체력적 부담이 크다. 주로 **젊고 건강한(50~60대)** 환자들이 선택한다.
2.  **시술 (Procedure, $T=0$)**: 카테터를 이용한 비침습적 시술(예: TAVI). 수술을 견디기 힘든 **고령(70~80대)이나 고위험군** 환자들이 주로 선택한다.

데이터를 열어보니 **시술군($T=0$)의 사망률이 압도적으로 높다.**
이것은 수술이 시술보다 탁월해서일까? 아니면 단순히 시술받은 사람들이 더 늙고 아파서일까? (Selection Bias).

우리의 목표는 '나이(Age)'라는 교란변수를 통제하고, **"수술이 시술보다 정말로 사망률을 낮추는가?"**에 답하는 것이다.

---

## 2. R Simulation: 가상 데이터 생성

현실을 모사한 데이터를 만들어보자.
*   **진실(Ground Truth)**: 수술($T=1$)은 시술($T=0$)에 비해 사망 위험을 낮춘다. (True Effect 존재)
*   **상황**: 나이가 많을수록 수술보다는 시술을 받으려 한다. 나이가 많을수록 사망 위험은 커진다.

````{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(MatchIt)  # PSM
library(WeightIt) # IPTW, OW
library(cobalt)   # Covariate Balance Plot
library(sandwich) # Robust SE
library(lmtest)   # Coeftest

set.seed(2026)
n <- 3000

# 1. 교란변수 생성: 나이 (Age)
# 전체 평균 65세, 표준편차 10
age <- rnorm(n, mean = 65, sd = 10)

# 2. 치료 배정 (Treatment Assignment)
# 나이가 젊을수록(-age) 수술(T=1) 받을 확률이 높음
# 나이가 50세면 수술 확률 > 90%, 80세면 수술 확률 < 10%
ps_true <- plogis(10 - 0.15 * age) 
treat <- rbinom(n, 1, ps_true)

# 3. 결과 생성 (Outcome: 1년 내 사망 여부)
# 기본 사망률은 나이에 비례 (+0.1*age)
# 수술(treat=1)을 받으면 사망 위험 감소 (-1.5)
# 노이즈 추가
mortality_prob <- plogis(-8 + 0.1 * age - 1.0 * treat)
mortality <- rbinom(n, 1, mortality_prob)

df <- tibble(age, treat, mortality)

# 데이터 확인
df %>%
  group_by(treat) %>%
  summarise(
    n = n(),
    mean_age = mean(age),
    mortality_rate = mean(mortality)
  )
````

**[실제 데이터 현황]**
*   **수술군(1)**: 평균 나이 60.3세, 사망률 6.6%
*   **시술군(0)**: 평균 나이 70.5세, 사망률 30.5%
*   $ightarrow$ 시술군이 나이가 10살이나 많고, 사망률은 5배 가까이 높다. 단순 비교 시 수술이 압도적으로 좋아 보일 수밖에 없다.

---

## 3. Naive Analysis: 보정하지 않은 결과

먼저 아무런 보정 없이 단순 회귀분석을 돌려보자.

````{r}
# 단순 비교
fit_naive <- glm(mortality ~ treat, data = df, family = binomial)
exp(coef(fit_naive))["treat"]
````
결과는 **OR 0.16** 수준이다. "수술하면 사망 위험이 84%나 감소한다!"라고 주장한다면 이는 나이 차이(Confounding)를 무시한 엉터리 주장이다.

---

## 4. Method 1: PSM (Target: ATT)

첫 번째 방법은 **성향점수 매칭(PSM)**이다. 가장 직관적이고 널리 쓰이는 방법이다.
우리는 **"실제로 수술을 받은 환자들(Treated)"**에게 관심이 있다.

> **질문 (ATT, Average Treatment Effect on the Treated)**: "이미 수술대에 누운 이 환자들(주로 60세 전후)이, 만약 시술을 받았다면 어땠을까?"

수술군과 비슷한 나이의 시술군을 찾아 짝을 짓는다.

````{r}
# PS 추정 및 매칭
m_out <- matchit(treat ~ age, data = df, method = "nearest", ratio = 1)
matched_data <- match.data(m_out)

# 밸런스 확인 (Love Plot)
love.plot(m_out, binary = "std", thresholds = c(m = .1))
````

*   **해석**: 매칭 후 두 그룹의 나이 차이가 거의 0이 되었다.
*   **주의점**: 수술군과 짝이 될 시술군이 부족한 **70~80대 초고령 수술 환자**나, 짝을 찾지 못한 **초고령 시술 환자**는 분석에서 **버려진다(Discarded)**.
*   **결과 추정 (ATT)**:
````{r}
fit_psm <- glm(mortality ~ treat + age, data = matched_data, family = binomial)
exp(coef(fit_psm))["treat"]
````
결과는 **OR 0.42** 수준이다. 나이를 보정하고 나니, 수술의 효과가 Naive한 분석(0.16)보다는 덜 극적인 것으로 나타났다. 이것이 **"수술을 선택한 집단"**에서의 진짜 수술 효과에 가깝다.

---

## 5. Method 2: IPTW (Target: ATE)

두 번째 방법은 **역확률 가중치(IPTW)**다. 데이터를 버리지 않고 전체를 쓴다.

> **질문 (ATE, Average Treatment Effect)**: "만약 전 국민(50대부터 80대까지 모두)에게 수술을 시켰다면, 전원 시술을 시켰을 때보다 사망률이 얼마나 낮았을까?"

문제는 현실적으로 80세 노인에게 개흉 수술을 시키는 건 불가능에 가깝다는 점이다. 데이터상으로도 80세 수술 환자는 극히 드물다. IPTW는 이 '드문 80세 수술 환자'에게 **어마어마한 가중치(Weight)**를 줘서 억지로 인구 구조를 맞춘다.

````{r}
# 가중치 생성 (WeightIt 패키지 사용 추천)
w_iptw <- weightit(treat ~ age, data = df, method = "ps", estimand = "ATE")

# 가중치 분포 확인 - Extreme Weight 주의!
summary(w_iptw$weights)

# 결과 추정 (ATE)
fit_iptw <- glm(mortality ~ treat, data = df, weights = w_iptw$weights, family = binomial)
# Robust SE 필수
coeftest(fit_iptw, vcov = vcovHC(fit_iptw, type = "HC1"))
exp(coef(fit_iptw))["treat"]
````
가중치의 최댓값(Max)이 **90**을 넘는다. 평균 가중치가 2.0 수준인데, 특정 환자 한 명의 가중치가 90배라는 것은 그 한 명의 데이터가 결과에 미치는 영향력이 비정상적으로 크다는 뜻이다. 결과값(OR 0.43) 자체는 PSM과 비슷해 보이지만, 추정의 **불안정성**이 내재되어 있다.

---

## 6. 심화: Overlap Weighting (Target: ATO)

IPTW의 불안정성(Extreme Weight)을 해결하기 위한 대안으로 **Overlap Weighting (OW)**이 있다.
이는 분산을 최소화하여 통계적 효율성을 극대화하지만, 그 대가로 우리가 알고 싶은 모집단(ATE, ATT)이 아닌 **'임상적으로 애매한(Equipose) 집단'**이라는 새로운 대상을 정의한다. 이를 **ATO (Average Treatment Effect in the Overlap population)**라고 한다.

````{r}
# ATO 가중치 생성
w_ow <- weightit(treat ~ age, data = df, method = "ps", estimand = "ATO")

# 가중치 분포 확인 - 매우 안정적
summary(w_ow$weights)

# 결과 추정 (ATO)
fit_ow <- glm(mortality ~ treat, data = df, weights = w_ow$weights, family = binomial)
exp(coef(fit_ow))["treat"]
````
가중치가 **0에서 1 사이**로 매우 안정적이다. 결과(OR 0.40) 역시 안정적으로 산출된다. 하지만 "이 결과가 전체 환자에게 적용되는가?"라는 질문에는 "아니오, 수술과 시술 사이에서 고민되는 중간층 환자에게만 해당됩니다"라고 답해야 한다.

---

## 7. 종합 비교: 어떤 숫자를 믿어야 할까?

| 방법론 | Estimand | 해석 | 특징 |
|:---:|:---:|:---|:---|
| **PSM** | **ATT** | "수술 받은 환자들(젊은 층)에겐 수술이 이만큼 좋았다." | 가장 직관적. 데이터 손실 발생. |
| **IPTW** | **ATE** | "모든 환자에게 수술을 시킨다면 이만큼 좋을 것이다." | 가중치 폭발 위험(불안정). 전체 인구 대표. |
| **OW** | **ATO** | "수술/시술 고민되는 환자들(중년)에겐 수술이 이만큼 좋다." | 통계적으로 가장 안정적. 대상 집단이 바뀜. |

### CATE (Conditional ATE)와 정밀 의료

결국 "평균적인 효과" 하나만으로는 부족할 때가 많다.
*   수술은 젊은 사람(ATT 타겟)에게는 효과적이지만, 80세 노인(ATE에 포함됨)에게는 오히려 해로울 수도 있다.
*   이처럼 환자의 특성($X$)에 따라 치료 효과가 달라지는 것을 **이질성(Heterogeneity)**이라고 하며, 이를 **CATE** 또는 **ITE (Individual Treatment Effect)**라고 한다.

최근의 인과추론 연구는 단순히 ATE/ATT를 구하는 것을 넘어, "누구에게 수술이 이득이고 누구에게 시술이 이득인가?"를 밝혀내는 정밀 의료(Precision Medicine)로 나아가고 있다.

다음 편에서는 이제 이 분석에 **'시간(Time)'** 개념을 섞어보자. 만약 수술은 바로 하는데, 시술은 대기 시간이 길다면? 치료 효과가 시간이 지날수록 변한다면? **Target Trial Emulation**이 필요한 시점이다.