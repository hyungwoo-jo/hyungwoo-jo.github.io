{
  "hash": "7478948dbfcad1cf0c7de94b46cd3176",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Causal Inference (2): Propensity Score Matching\"\ndescription: \"ATE와 ATT의 차이, 그리고 Love Plot 해석하기\"\nimage: img/image.jpg\ncategories: [statistics, causal-inference, R]\nauthor:\n  - name: Hyungwoo Jo\n    url: https://github.com/hyungwoo-jo\nfig_width: 400\ndate: 2026-01-02\nformat: html\nexecute:\n  freeze: true\ndraft: false\ncitation: true\n---\n\n\n\n1편에서는 인과추론의 필요성에 대해 알아보았다. 2편에서는 실제 의학 연구에서 가장 빈번하게 마주치는 상황을 통해, **성향점수(Propensity Score)**를 이용한 다양한 분석 방법론(**PSM, IPTW, OW**)이 어떻게 다른 결론을 도출하는지, 그리고 그 각각의 결론(**ATT, ATE, ATO**)이 어떤 의미를 갖는지(또 결과가 얼마나 민감한지) 파고들어 보자.\n\n------------------------------------------------------------------------\n\n## 1. Example: Procedure vs Surgery\n\n아래의 예시를 살펴보자. 심장판막 질환 환자에게는 두 가지 선택지가 있다고 가정하자(예시를 위한 것이고 실제 임상적 사실과는 차이가 있을 수 있다)\n\n1.  **수술 (Surgery,** $T=1$): 젊은 환자(50\\~60대)에게는 완치에 가깝지만, 80대 이상 노인에게는 수술 자체가 사망 위험을 높일 수 있다.\n2.  **시술 (Procedure,** $T=0$): 비침습적 시술. 고령 환자가 주로 선택한다.\n\n데이터를 열어보니 시술군**(**$T=0$)의 사망률이 높다. 하지만 이는 시술군이 고령이기 때문일 수 있다. 더 중요한 것은, \"수술이 정말 모든 사람(80대 포함)에게 정답인가?\"이다.\n\n우리가 알고 있는 임상적 사실들을 기반으로 데이터를 만들어보자. 이번 시뮬레이션의 핵심은 치료 효과의 이질성(Interaction)이다. 대략 나이대에 따라 아래와 같이 데이터를 만들어보겠다. 50대: 수술 시 사망률 감소. \\* 70대: 수술과 시술의 효과가 비슷함. \\* 고령: 수술 시 오히려 사망률 증가 (수술 위험).\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(MatchIt)\nlibrary(WeightIt)\nlibrary(cobalt)\nlibrary(sandwich)\nlibrary(lmtest)\nlibrary(data.table)\n\nset.seed(1234)\nn <- 50000\n\n# 1. 교란변수: 나이 (Age)\nage <- rnorm(n, mean = 65, sd = 15)\n\n# 2. 치료 배정\n# 젊을수록 수술 확률 높지만, 너무 극단적이지 않게 설정\nps_true <- plogis(3 - 0.05 * age) \ntreat <- rbinom(n, 1, ps_true)\n\n# 3. 결과 생성 (Outcome)\ntrt_logOR <- ifelse(age <= 66, -0.2 * (66 - age), 0.001 * (age - 66)^2)\nmortality_prob <- plogis(-2.4 + 0.07 * (age - 65) + treat * trt_logOR)\nmortality <- rbinom(n, 1, mortality_prob)\n\ndf <-tibble(age, treat, mortality)\ndt<- as.data.table(df) \n\n# 수술군과 비수술군의 평균 나이 비교 \ndt[, .(mean_age = mean(age)), by = treat]\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   treat mean_age\n   <int>    <num>\n1:     0 69.48718\n2:     1 59.42072\n```\n\n\n:::\n\n```{.r .cell-code}\n# 간단한 리스크(사망률) 요약 함수 (가중치 있으면 가중 평균)\nestimate_risk <- function(data, w = NULL) {\n  if (is.null(w)) w <- rep(1, nrow(data))\n  p1 <- weighted.mean(data$mortality[data$treat == 1], w[data$treat == 1])\n  p0 <- weighted.mean(data$mortality[data$treat == 0], w[data$treat == 0])\n  tibble(p_treat = p1, p_control = p0, RD = p1 - p0, RR = p1 / p0)\n}\n```\n:::\n\n\n\n이 데이터 구조에서 ATT (수술받은 사람들의 효과)는 결국 수술받은 사람들(평균 60살 정도의 젊은 연령층)에게서의 수술 vs 시술의 치료효과라고 할 수 있을 것이다. ATE (전체 인구의 효과: 데이터에서 설정한 65세 즉 60세 수술군과 대략 69세 수술군의 평균 인구)에서의 수술 vs 시술의 치료효과라고 할 수 있을 것이다.\n\n------------------------------------------------------------------------\n\n## 2. Method 1: Propensity Score Matching\n\n우리는 실제로 수술을 선택할 환자들(상대적으로 젊은 연령층)에게 관심이 있다고 생각해보자. 따라서 Propensity Score matching을 통해 시술군(평균 연령 69세)에서 연령이 비교적 젊은, 즉 수술군과 유사한 사람들만을 선별해내는 과정을 진행할것이다\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 1:1 Matching \nm_out <- matchit(treat ~ age, data = dt, method = \"nearest\", ratio = 1, caliper = 0.1)\nmatched_data <- as.data.table(match.data(m_out))\nmatched_data[,.(mean_age= mean(age)), by = treat]\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   treat mean_age\n   <int>    <num>\n1:     0 63.40875\n2:     1 62.65488\n```\n\n\n:::\n:::\n\n\n\nMatching을 진행한 결과 시술군들의 집단도 상대적으로 젊은 연령(평균 62세)의 사람들만 모집된 것을 알 수 있다.\n\n### 결과 추정 (ATT)\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(jstable)\n# (1) 매칭된 표본에서의 사망률 차이 (리스크 스케일; ATT에 가까운 해석)\nestimate_risk(matched_data, w = matched_data$weights)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 × 4\n  p_treat p_control      RD    RR\n    <dbl>     <dbl>   <dbl> <dbl>\n1  0.0848    0.0964 -0.0117 0.879\n```\n\n\n:::\n\n```{.r .cell-code}\n# (2) 참고: OR로 요약 (모형 가정에 민감)\nfit_psm <- glm(mortality ~ treat + age, data = matched_data, weights = matched_data$weights, family = binomial())\n# OR 계산\ntt<- glmshow.display(fit_psm, decimal = 2)\nprint(tt)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n$first.line\n[1] \"Logistic regression predicting mortality\\n\"\n\n$table\n      crude OR.(95%CI)   crude P value adj. OR.(95%CI)    adj. P value\ntreat \"0.87 (0.81,0.93)\" \"< 0.001\"     \"0.88 (0.81,0.95)\" \"< 0.001\"   \nage   \"1.09 (1.09,1.1)\"  \"< 0.001\"     \"1.09 (1.09,1.1)\"  \"< 0.001\"   \n\n$last.lines\n[1] \"No. of observations = 36880\\nAIC value = 19133.8138\\n\\n\"\n\nattr(,\"class\")\n[1] \"display\" \"list\"   \n```\n\n\n:::\n:::\n\n\n\n매칭은 \"수술을 받은 사람들(상대적으로 젊은 집단)\"을 타겟으로 하였기 때문에 우리가 지금 확인하고 있는 오즈비는 **ATT** 의관점에 가깝다는 것을 알 수 있다. 즉 상대적으로 젊은 집단에서는 수술을 하는 것이 시술을 하는 것에 비해 사망의 위험을 줄여준다고 가정할 수 있다. 하지만 이것이 과연 심장판막 질환을 가진 모든 환자에게 수술을 권하는 데이터로 활용될 수 있을까? 여기서 지금 매칭을 하였기 때문에 실제 평균 연령보다 상대적으로 젊고 건강한 군에서 시행한 데이터라는 것을 알 수 있다.\n\n------------------------------------------------------------------------\n\n## 3. Method 2: IPTW (Target: ATE)\n\n이번엔 질문을 바꿔보자. **\"만약 심장 판막 질환을 진단 받은 전 인구에 대해 수술을 권장한다면?\"**\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nw_ate <- weightit(treat ~ age, data = dt, method = \"glm\", estimand = \"ATE\")\nsummary(w_ate$weights)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n  1.043   1.458   1.753   2.000   2.247  18.902 \n```\n\n\n:::\n\n```{.r .cell-code}\n# (1) 리스크 스케일: 가중 사망률 차이 (ATE)\nestimate_risk(dt, w = w_ate$weights)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 × 4\n  p_treat p_control      RD    RR\n    <dbl>     <dbl>   <dbl> <dbl>\n1   0.119     0.118 0.00114  1.01\n```\n\n\n:::\n\n```{.r .cell-code}\ndt[, .(w_mean_age = weighted.mean(age, w_ate$weights)), by = treat]\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   treat w_mean_age\n   <int>      <num>\n1:     0   65.02374\n2:     1   65.00779\n```\n\n\n:::\n\n```{.r .cell-code}\n# (2) 참고: OR로 요약 (robust SE)\nfit_iptw <- glm(mortality ~ treat+age, data = dt, weights = w_ate$weights, family = binomial())\nglmshow.display(fit_iptw)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n$first.line\n[1] \"Logistic regression predicting mortality\\n\"\n\n$table\n      crude OR.(95%CI)   crude P value adj. OR.(95%CI)    adj. P value\ntreat \"1.01 (0.97,1.05)\" \"0.578\"       \"1.02 (0.98,1.06)\" \"0.407\"     \nage   \"1.09 (1.09,1.09)\" \"< 0.001\"     \"1.09 (1.09,1.09)\" \"< 0.001\"   \n\n$last.lines\n[1] \"No. of observations = 50000\\nAIC value = 57385.922\\n\\n\"\n\nattr(,\"class\")\n[1] \"display\" \"list\"   \n```\n\n\n:::\n:::\n\n\n\nIPTW로 weight를 적용한한 데이터에 대해서 살펴보자. 지금 데이터를 보면 알 수 있듯이 처음에 가정한것 처럼 평균 65세의 심장판막 진단 환자군이라는 것을 알 수 있다. 즉, IPTW는 전체 인구(고령 포함)를 타겟으로 하므로, 결과는 **ATE** 관점이다. 여기서 확인할 수 있는 결과는 심장판막 질환을 진단받은 모든 사람을 대상으로 수술과 시술의 효과를 비교했을 때는 OR이 1 그리고 p-value가 0.578로 두 시술의 효과가 크게 차이가 없다는 것을 알 수 있다.\n\n------------------------------------------------------------------------\n\n### 1살(age) 단위 strata에서의 OR (전체 인구)\n\n표본이 충분하다면 age를 1살 단위로 나눠서, 각 strata에서 `OR(Surgery vs Procedure)`를 구한 뒤 점을 선으로 이어 보는 방식이 가장 직관적이다.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nor_by_age1 <- dt %>%\n  as_tibble() %>%\n  mutate(age1 = floor(age)) %>%\n  group_by(age1) %>%\n  group_modify(function(.x, .y) {\n    tab <- table(.x$mortality, .x$treat)\n    if (nrow(tab) < 2 || ncol(tab) < 2 || any(tab < 3)) {\n      return(tibble(or = NA_real_, lo = NA_real_, hi = NA_real_))\n    }\n\n    fit <- glm(mortality ~ treat, data = .x, family = binomial())\n    co <- summary(fit)$coef\n    est <- co[\"treat\", \"Estimate\"]\n    se <- co[\"treat\", \"Std. Error\"]\n\n    tibble(or = exp(est), lo = exp(est - 1.96 * se), hi = exp(est + 1.96 * se))\n  }) %>%\n  ungroup() %>%\n  filter(!is.na(or))\n\nggplot(or_by_age1, aes(x = age1, y = or)) +\n  geom_ribbon(aes(ymin = lo, ymax = hi), alpha = 0.12) +\n  geom_point(size = 0.9, alpha = 0.8) +\n  geom_line(linewidth = 0.7) +\n  geom_hline(yintercept = 1, linetype = 2) +\n  scale_y_log10() +\n  coord_cartesian(ylim = c(0.2, 5)) +\n  labs(x = \"Age (years)\", y = \"OR (Surgery vs Procedure)\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n\n## 6. 결론: 상반된 결과의 해석\n\nATT와 ATE는 “어떤 질문에 답하는가”가 다르다. 같은 데이터로도 타겟(estimand)을 바꾸면 요약 효과가 달라질 수 있으므로, 분석 전에 질문을 먼저 고정해야 한다.\n\n1.  **ATT**: “실제로 수술을 받은 사람들”을 기준으로, *그들이 시술을 받았더라면?* (즉, treated 집단에서의 평균 효과)\n2.  **ATE**: “타겟 인구 전체”에서, *모두 수술 vs 모두 시술로 무작위 배정한다면 평균적으로 어떻게 달라질까?* (RCT가 추정하는 평균 효과에 가까운 질문)\n\n그리고 치료 효과가 개인/집단 특성(예: age)에 따라 달라진다면, 평균 효과(ATE/ATT)만 보지 말고 **ITE/CATE(예: age strata별 효과)**도 같이 확인하는 게 해석에 도움이 된다.\n\n조금 더 확장해보면:\n\n-   **ITE (Individual Treatment Effect)**: 한 개인 $i$에 대해 $Y_i(1)-Y_i(0)$처럼 정의되는 “개인 수준 효과”다. 하지만 반사실적 결과는 동시에 관측할 수 없어서, ITE 자체는 직접 관측되지 않고(근본 문제), 가정/모형 하에서 **예측**의 형태로 다룬다.\n-   **CATE (Conditional ATE)**: 특정 조건(예: 60대, 여성, 특정 risk score 구간)에서의 평균 효과 $E[Y(1)-Y(0)\\mid X=x]$로, “어떤 집단에서 더 이득/해가 큰가?”를 답한다. 위에서 그린 **age strata별 OR**은 CATE를 아주 단순하게(나이만으로 층화) 들여다보는 한 방법이다.\n-   실전에서는 CATE를 보기 위해 (1) 사전에 정의한 subgroup 분석, (2) `treat × covariate` 상호작용 모형, (3) 보다 유연한 ML 기반 방법(예: causal forest/DR-learner 등) 같은 접근을 쓴다. 중요한 건 “전체 평균(ATE/ATT)”을 한 줄로 결론내리기 전에, **효과 이질성(heterogeneity)**이 결론을 바꿀 만큼 큰지 함께 점검하는 것이다.\n\n다음 편에서는 이 복잡한 이야기에 **시간(Time)**을 더해보자. **Immortal Time Bias**와 **Target Trial Emulation**으로 가는 여정이다.\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}