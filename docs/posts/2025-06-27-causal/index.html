<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Anonymous">
<meta name="dcterms.date" content="2025-06-27">
<meta name="description" content="의학 연구에서의 인과추론: 기본 개념">
<title>Causal Inference (1) – Analytics Notes</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-de84f8d6bb715db06a919283c2d1e787.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-31532e0a7f1fd90059c3306d8d248c7c.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><style>html{ scroll-behavior: smooth; }</style>
<script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script><link rel="stylesheet" href="../../styles.css">
</head>
<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner"><nav class="navbar navbar-expand-lg " data-bs-theme="dark"><div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Analytics Notes</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
<li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Posts</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
<ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item compact">
    <a class="nav-link" href="https://github.com/sl-eeper"> <i class="bi bi-github" role="img" aria-label="GitHub Profile">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
</div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full"><div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Causal Inference (1)</h1>
                  <div>
        <div class="description">
          의학 연구에서의 인과추론: 기본 개념
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">statistics</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Anonymous </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">June 27, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">On this page</h2>
   
  <ul>
<li><a href="#%EC%9D%B8%EA%B3%BC%EC%B6%94%EB%A1%A0%EC%9D%98-%EA%B7%BC%EB%B3%B8%EC%A0%81%EC%9D%B8-%EB%AC%B8%EC%A0%9C-the-fundamental-problem-of-causal-inference" id="toc-인과추론의-근본적인-문제-the-fundamental-problem-of-causal-inference" class="nav-link active" data-scroll-target="#%EC%9D%B8%EA%B3%BC%EC%B6%94%EB%A1%A0%EC%9D%98-%EA%B7%BC%EB%B3%B8%EC%A0%81%EC%9D%B8-%EB%AC%B8%EC%A0%9C-the-fundamental-problem-of-causal-inference">1. 인과추론의 근본적인 문제 (The Fundamental Problem of Causal Inference)</a></li>
  <li>
<a href="#%EB%AC%B4%EC%9E%91%EC%9C%84-%EB%B0%B0%EC%A0%95-%EC%9E%84%EC%83%81%EC%8B%9C%ED%97%98-rct%EA%B3%BC-%EA%B5%90%ED%99%98%EA%B0%80%EB%8A%A5%EC%84%B1" id="toc-무작위-배정-임상시험-rct과-교환가능성" class="nav-link" data-scroll-target="#%EB%AC%B4%EC%9E%91%EC%9C%84-%EB%B0%B0%EC%A0%95-%EC%9E%84%EC%83%81%EC%8B%9C%ED%97%98-rct%EA%B3%BC-%EA%B5%90%ED%99%98%EA%B0%80%EB%8A%A5%EC%84%B1">2. 무작위 배정 임상시험 (RCT)과 교환가능성</a>
  <ul class="collapse">
<li><a href="#%EB%AC%B4%EC%9E%91%EC%9C%84-%EB%B0%B0%EC%A0%95%EA%B3%BC-%ED%8F%89%EA%B7%A0-%EC%9D%B8%EA%B3%BC-%ED%9A%A8%EA%B3%BC-%EC%B6%94%EC%A0%95" id="toc-무작위-배정과-평균-인과-효과-추정" class="nav-link" data-scroll-target="#%EB%AC%B4%EC%9E%91%EC%9C%84-%EB%B0%B0%EC%A0%95%EA%B3%BC-%ED%8F%89%EA%B7%A0-%EC%9D%B8%EA%B3%BC-%ED%9A%A8%EA%B3%BC-%EC%B6%94%EC%A0%95">무작위 배정과 평균 인과 효과 추정</a></li>
  <li><a href="#%EA%B5%90%ED%99%98%EA%B0%80%EB%8A%A5%EC%84%B1-exchangeability-rct%EC%9D%98-%ED%95%B5%EC%8B%AC-%EA%B0%80%EC%A0%95" id="toc-교환가능성-exchangeability-rct의-핵심-가정" class="nav-link" data-scroll-target="#%EA%B5%90%ED%99%98%EA%B0%80%EB%8A%A5%EC%84%B1-exchangeability-rct%EC%9D%98-%ED%95%B5%EC%8B%AC-%EA%B0%80%EC%A0%95">교환가능성 (Exchangeability): RCT의 핵심 가정</a></li>
  </ul>
</li>
  <li>
<a href="#%EA%B4%80%EC%B0%B0-%EC%97%B0%EA%B5%AC%EC%99%80-%EC%A1%B0%EA%B1%B4%EB%B6%80-%EA%B5%90%ED%99%98%EA%B0%80%EB%8A%A5%EC%84%B1" id="toc-관찰-연구와-조건부-교환가능성" class="nav-link" data-scroll-target="#%EA%B4%80%EC%B0%B0-%EC%97%B0%EA%B5%AC%EC%99%80-%EC%A1%B0%EA%B1%B4%EB%B6%80-%EA%B5%90%ED%99%98%EA%B0%80%EB%8A%A5%EC%84%B1">3. 관찰 연구와 조건부 교환가능성</a>
  <ul class="collapse">
<li><a href="#r-%EA%B5%90%EB%9E%80-%ED%9A%A8%EA%B3%BC-%EC%8B%9C%EB%AE%AC%EB%A0%88%EC%9D%B4%EC%85%98" id="toc-r-교란-효과-시뮬레이션" class="nav-link" data-scroll-target="#r-%EA%B5%90%EB%9E%80-%ED%9A%A8%EA%B3%BC-%EC%8B%9C%EB%AE%AC%EB%A0%88%EC%9D%B4%EC%85%98">R: 교란 효과 시뮬레이션</a></li>
  </ul>
</li>
  <li><a href="#%EB%AF%B8%EC%B8%A1%EC%A0%95-%EA%B5%90%EB%9E%80%EB%B3%80%EC%88%98%EC%9D%98-%ED%95%9C%EA%B3%84" id="toc-미측정-교란변수의-한계" class="nav-link" data-scroll-target="#%EB%AF%B8%EC%B8%A1%EC%A0%95-%EA%B5%90%EB%9E%80%EB%B3%80%EC%88%98%EC%9D%98-%ED%95%9C%EA%B3%84">4. 미측정 교란변수의 한계</a></li>
  <li><a href="#%EC%8B%9C%EA%B0%84%EC%B6%95%EA%B4%80%EB%A0%A8-%ED%8E%B8%ED%96%A5-time-related-biases" id="toc-시간축관련-편향-time-related-biases" class="nav-link" data-scroll-target="#%EC%8B%9C%EA%B0%84%EC%B6%95%EA%B4%80%EB%A0%A8-%ED%8E%B8%ED%96%A5-time-related-biases">5. 시간축관련 편향 (Time-related Biases)</a></li>
  <li><a href="#immortal-time-bias%EC%99%80-healthy-user-bias" id="toc-immortal-time-bias와-healthy-user-bias" class="nav-link" data-scroll-target="#immortal-time-bias%EC%99%80-healthy-user-bias">5.1 Immortal Time Bias와 Healthy User Bias</a></li>
  <li><a href="#prevalent-user-bias" id="toc-prevalent-user-bias" class="nav-link" data-scroll-target="#prevalent-user-bias">5.2 Prevalent User Bias</a></li>
  <li><a href="#%EA%B2%B0%EB%A1%A0" id="toc-결론" class="nav-link" data-scroll-target="#%EA%B2%B0%EB%A1%A0">6 결론</a></li>
  </ul></nav>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content"><p>영화 에브리씽 에브리웨어 올 앳 원스(Everything Everywhere All at Once)에서 평범한 세탁소의 주인인 에블린은 다른 평행 우주의 자신들과 연결될 수 있는 존재임을 깨닫는다. 그녀가 본 그녀의 평행 우주에는 남편을 따라 미국으로 가지 않았다면, 세계적인 영화배우가 된 자신 미슐랭 스타를 받은 요리사가 된 그녀의 삶부터 접시 돌리기를 하며 다른 사람과 결혼한 삶 등이 있다. 그리고 다른 한 편에는 에블린의 딸의 다른 자아인 조부 투파키가 있다. 조부 투파키는 수많은 평행우주의 삶들을 보았고, 다중우주의 가능성과 존재의 의미없음을 깨달아 버린 존재다. 조부 투파키가 가져오는 수많은 허무에 맞서, 에블린은 역설적으로 화려한 다중우주 속에서 초라하고 평범해보이는 자신의 삶의 소중함을 깨닫는다.</p>
<p>우리는 늘 평행 우주속의 또 다른 나를 상상하며 산다. 다른 나라에서 태어난 나 혹은 다른 전공을 선택한 평행우주의 나를 상상하며 살아가곤 한다. 일어나지 않은 일을 상상할 수 있다는 것은 우리에게 어떤 의미를 가질까.</p>
<hr>
<section id="인과추론의-근본적인-문제-the-fundamental-problem-of-causal-inference" class="level2"><h2 class="anchored" data-anchor-id="인과추론의-근본적인-문제-the-fundamental-problem-of-causal-inference">1. 인과추론의 근본적인 문제 (The Fundamental Problem of Causal Inference)</h2>
<p>임상 현장에서는 특정 질환에 대해 여러 치료 대안이 존재할 때, 어떤 치료법이 더 나은 예후를 가져오는지 판단해야 하는 문제에 직면한다. 예를 들어, 특정 암으로 진단된 65세 남성 환자 ‘A’씨가 있고, 치료법으로 ’수술’과 ’약물치료’가 고려되고 있다고 가정해 보자. 이 연구에서 관심 있는 최종 결과는 ’1년 후 생존 여부’(생존 시 1, 사망 시 0)이다.</p>
<p>인과추론의 핵심 개념인 잠재적 결과 프레임워크(Potential Outcomes Framework)는 이 상황을 다음과 같이 설명한다. A씨에게는 우리가 관찰할 수는 없지만 개념적으로 존재하는 두 가지의 잠재적 결과가 있다.</p>
<ul>
<li>
<span class="math inline">\(Y_{A}(1)\)</span>: A씨가 ’수술’을 받았을 경우의 1년 후 생존 상태</li>
<li>
<span class="math inline">\(Y_{A}(0)\)</span>: A씨가 ’약물치료’를 받았을 경우의 1년 후 생존 상태</li>
</ul>
<p>만약 우리가 신처럼 모든 가능성을 알 수 있어, A씨가 수술을 받으면 1년 후 생존하고(<span class="math inline">\(Y_{A}(1)=1\)</span>), 약물치료를 받으면 1년 후 사망한다(<span class="math inline">\(Y_{A}(0)=0\)</span>)는 사실을 안다고 상상해 보자. 이때 A씨 개인에 대한 수술의 인과적 효과는 <span class="math inline">\(Y_{A}(1) - Y_{A}(0) = 1 - 0 = 1\)</span>로 명확하게 계산된다. 이 차이값, 즉 <strong>한 개인에 대한 잠재적 결과들의 차이가 바로 우리가 궁극적으로 알고자 하는 ‘진정한 인과적 효과(true causal effect)’</strong>이다. 이는 해당 치료가 그 개인에게 미친 순수한 영향의 크기를 의미한다.</p>
<p>그러나 현실 세계에서 A씨는 두 가지 치료 중 단 하나만 받을 수 있다. 만약 그가 실제로 수술을 선택하여 1년 후 생존했다면, 우리는 <span class="math inline">\(Y_{A}(1)=1\)</span>이라는 ‘사실적(factual)’ 결과만을 관찰할 수 있다. 그가 만약 약물치료를 받았더라면 어땠을지에 대한 결과, 즉 <span class="math inline">\(Y_{A}(0)\)</span>의 값은 영원히 관찰 불가능한 ’반사실적 사실(Counterfactual)’로 남게 된다.</p>
<p>이처럼 동일한 개인에 대해 모든 잠재적 결과를 동시에 관찰하는 것이 원천적으로 불가능하다는 점, 이것이 바로 <strong>‘인과추론의 근본적인 문제(The Fundamental Problem of Causal Inference)’</strong>이다.</p>
<hr></section><section id="무작위-배정-임상시험-rct과-교환가능성" class="level2"><h2 class="anchored" data-anchor-id="무작위-배정-임상시험-rct과-교환가능성">2. 무작위 배정 임상시험 (RCT)과 교환가능성</h2>
<p>앞에서 살펴본 ‘A씨’ 개인에 대한 수술의 인과적 효과(<span class="math inline">\(Y_{A}(1) - Y_{A}(0)\)</span>)를 아는 것은 <strong>‘인과추론의 근본적인 문제’</strong>로 인해 불가능하다. 그렇다면 연구자로서 우리는 어떤 의미 있는 질문을 던질 수 있을까? 바로 “A씨 한 명이 아니라, A씨와 유사한 특성을 가진 환자 집단 전체에서 수술은 약물치료에 비해 평균적으로 얼마나 효과적인가?”라는 질문이다. 이처럼 목표를 개인에서 집단으로 수정하여, 특정 인구 집단 전체에 대한 <strong>’평균 인과 효과(Average Causal Effect, ACE 또는 Average Treatment Effect, ATE)</strong>를 추정하는 것으로 전환한다.</p>
<p>이 개념을 이해하기 위해, 해당 질환을 가진 환자가 10명(A부터 J까지)뿐인 가상의 인구 집단을 상상해 보자. 신의 관점에서 이들 각각의 잠재적 결과를 모두 알고 있다고 가정하면 아래 표와 같다. (생존=1, 사망=0)</p>
<table class="caption-top table">
<colgroup>
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
</colgroup>
<thead><tr class="header">
<th style="text-align: left;">환자</th>
<th style="text-align: center;">수술 시 생존 여부 <span class="math inline">\(Y(1)\)</span>
</th>
<th style="text-align: center;">약물치료 시 생존 여부 <span class="math inline">\(Y(0)\)</span>
</th>
<th style="text-align: center;">개인의 인과 효과 <span class="math inline">\(Y(1) - Y(0)\)</span>
</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">A</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">B</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">C</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">D</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">E</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">F</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">G</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">-1</td>
</tr>
<tr class="even">
<td style="text-align: left;">H</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">I</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">J</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">1</td>
</tr>
</tbody>
</table>
<p>위 표에서 각 개인에 대한 치료의 인과 효과는 이질적(heterogeneous)이다. A, D, E, H, J 환자에게 수술은 생존을 결정짓는 긍정적 효과(+1)를 가진다. B와 F 환자에게는 두 치료법 모두 효과가 있어 차이가 없고(0), C와 I 환자에게는 두 치료법 모두 효과가 없어 역시 차이가 없다(0). 특히 G 환자의 경우, 오히려 약물치료가 더 나은 결과를 보여 수술의 효과는 부정적(-1)이다. <strong>현실에서는 이 마지막 열, 즉 개인별 효과를 결코 알 수 없다.</strong></p>
<p><strong>평균 인과 효과(ACE)</strong>는 바로 이 마지막 열에 있는 개인별 인과 효과들의 평균이다. <span class="math display">\[\text{ACE} = \frac{1+0+0+1+1+0+(-1)+1+0+1}{10} = \frac{4}{10} = 0.4\]</span> 이 값 <span class="math inline">\(0.4\)</span>는 이 인구 집단에서 약물치료 대신 수술을 선택할 경우, 생존할 확률이 <strong>평균적으로</strong> <span class="math inline">\(0.4\)</span> (또는 <span class="math inline">\(40\%\)</span>p) 증가함을 의미한다. 이는 G 환자처럼 일부에게는 수술이 해가 되더라도, 집단 전체적으로는 수술이 더 이득이 됨을 보여주는 중요한 정보다.</p>
<p>이처럼 개인 수준의 효과는 알 수 없지만, 연구자들은 집단 수준의 평균적인 효과를 추정함으로써 치료법의 가치를 평가하고 임상적 의사결정에 대한 과학적 근거를 제공할 수 있다. 앞선 예시에서 우리가 신의 관점으로 계산한 ‘진정한’ 평균 인과 효과(ACE)는 <span class="math inline">\(0.4\)</span>였다. 이제 현실의 연구자가 이 값을 어떻게 추정해 나가는지 살펴본다.</p>
<hr>
<section id="무작위-배정과-평균-인과-효과-추정" class="level3"><h3 class="anchored" data-anchor-id="무작위-배정과-평균-인과-효과-추정">무작위 배정과 평균 인과 효과 추정</h3>
<p>이 평균 인과 효과를 가장 신뢰도 높게 추정하기 위한 연구 설계가 바로 <strong>무작위 배정 임상시험(Randomized Controlled Trial, RCT)</strong>이다. RCT의 핵심은 <strong>무작위 배정(randomization)</strong>에 있다. 앞선 10명의 환자(A~J)를 동전 던지기와 같은 확률적 과정에 따라 5명은 수술군(Treatment, <span class="math inline">\(T=1\)</span>)에, 나머지 5명은 약물치료군(Control, <span class="math inline">\(T=0\)</span>)에 배정한다고 가정해 보자.</p>
<p>무작위 배정은 매우 강력한 도구로, 각 환자가 어떤 치료를 받을지 <strong>오직 우연에 의해서만 결정</strong>되도록 한다. 만약 대상자 수가 충분히 많다면, 무작위 배정은 치료군과 대조군이 치료와 무관한 모든 특성(나이, 성별, 기저 질환의 중증도, 생활 습관 등)에서 <strong>평균적으로 거의 동일하게 분포</strong>되도록 만든다. 이는 마치 두 집단이 <strong>‘복제된(counterfactual) 상태’</strong>와 같이 되는 것을 의미한다.</p>
<p>여기서는 10명이라는 소규모 집단이지만, 무작위 배정이 성공적으로 이루어져 두 그룹의 기저 특성이 잘 균형을 이루었다고 가정해 보자. 예를 들어, 한 가지 무작위 배정 결과가 아래와 같이 나왔다고 하자.</p>
<ul>
<li>
<strong>수술군 (</strong><span class="math inline">\(T=1\)</span>): {A, D, E, H, J}</li>
<li>
<strong>약물치료군 (</strong><span class="math inline">\(T=0\)</span>): {B, C, F, G, I}</li>
</ul>
<p>연구자는 이제 신의 관점이 아닌, 실제 관찰된 데이터만을 볼 수 있다. 즉, 수술군에 속한 환자에게서는 수술 후의 결과(<span class="math inline">\(Y(1)\)</span>)만을, 약물치료군에 속한 환자에게서는 약물치료 후의 결과(<span class="math inline">\(Y(0)\)</span>)만을 관찰하게 된다.</p>
<table class="caption-top table">
<thead><tr class="header">
<th style="text-align: left;">환자</th>
<th style="text-align: center;">배정된 군 (T)</th>
<th style="text-align: center;">실제 관찰된 결과 (Y)</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">A</td>
<td style="text-align: center;">1 (수술)</td>
<td style="text-align: center;"><span class="math inline">\(Y_{A}(1)=1\)</span></td>
</tr>
<tr class="even">
<td style="text-align: left;">B</td>
<td style="text-align: center;">0 (약물)</td>
<td style="text-align: center;"><span class="math inline">\(Y_{B}(0)=1\)</span></td>
</tr>
<tr class="odd">
<td style="text-align: left;">C</td>
<td style="text-align: center;">0 (약물)</td>
<td style="text-align: center;"><span class="math inline">\(Y_{C}(0)=0\)</span></td>
</tr>
<tr class="even">
<td style="text-align: left;">D</td>
<td style="text-align: center;">1 (수술)</td>
<td style="text-align: center;"><span class="math inline">\(Y_{D}(1)=1\)</span></td>
</tr>
<tr class="odd">
<td style="text-align: left;">E</td>
<td style="text-align: center;">1 (수술)</td>
<td style="text-align: center;"><span class="math inline">\(Y_{E}(1)=1\)</span></td>
</tr>
<tr class="even">
<td style="text-align: left;">F</td>
<td style="text-align: center;">0 (약물)</td>
<td style="text-align: center;"><span class="math inline">\(Y_{F}(0)=1\)</span></td>
</tr>
<tr class="odd">
<td style="text-align: left;">G</td>
<td style="text-align: center;">0 (약물)</td>
<td style="text-align: center;"><span class="math inline">\(Y_{G}(0)=1\)</span></td>
</tr>
<tr class="even">
<td style="text-align: left;">H</td>
<td style="text-align: center;">1 (수술)</td>
<td style="text-align: center;"><span class="math inline">\(Y_{H}(1)=1\)</span></td>
</tr>
<tr class="odd">
<td style="text-align: left;">I</td>
<td style="text-align: center;">0 (약물)</td>
<td style="text-align: center;"><span class="math inline">\(Y_{I}(0)=0\)</span></td>
</tr>
<tr class="even">
<td style="text-align: left;">J</td>
<td style="text-align: center;">1 (수술)</td>
<td style="text-align: center;"><span class="math inline">\(Y_{J}(1)=1\)</span></td>
</tr>
</tbody>
</table>
<p>이 관찰된 데이터를 바탕으로 연구자는 각 그룹의 평균 결과를 계산한다.</p>
<ul>
<li>관찰된 수술군의 평균 생존율: <span class="math inline">\(E[Y|T=1] = (1+1+1+1+1)/5 = 1.0\)</span>
</li>
<li>관찰된 약물치료군의 평균 생존율: <span class="math inline">\(E[Y|T=0] = (1+0+1+1+0)/5 = 0.6\)</span>
</li>
<li>관찰된 결과의 차이: <span class="math inline">\(1.0 - 0.6 = 0.4\)</span>
</li>
</ul>
<p>이 값(<span class="math inline">\(0.4\)</span>)은 우리가 앞에서 신의 관점으로 계산했던 <strong>실제 ACE(</strong><span class="math inline">\(0.4\)</span>)와 정확히 일치한다. 10명이라는 작은 표본에서도 무작위 배정이 성공적으로 이루어진다면 이렇게 실제 평균 인과 효과를 잘 추정할 수 있다. 물론 실제 임상 연구에서는 무작위 오차(Random Error)를 줄이기 위해 훨씬 더 많은 수의 환자를 대상으로 연구를 수행하며, 이러한 과정을 통해 관찰된 차이는 ‘진정한’ 평균 인과 효과에 더욱 가깝게 수렴하게 된다.</p>
<hr></section><section id="교환가능성-exchangeability-rct의-핵심-가정" class="level3"><h3 class="anchored" data-anchor-id="교환가능성-exchangeability-rct의-핵심-가정">교환가능성 (Exchangeability): RCT의 핵심 가정</h3>
<p>이것이 가능한 근본적인 원리가 바로 <strong>교환가능성(Exchangeability)</strong>이다. 무작위 배정은 두 집단의 모든 특성을 평균적으로 동일하게 만들어, 치료 개입이 시작되기 전 시점에서 두 집단을 통계적으로 거의 복제된 상태로 만든다. ’교환가능성’은 기호를 통해 더 깊이 이해할 수 있다. 무작위 배정 덕분에 우리는 치료군과 대조군의 잠재적 결과가 다음과 같은 관계를 가진다고 가정할 수 있다.</p>
<p>우리가 앞서 본 10명의 환자 예시를 다시 떠올려 보자. 이 환자들을 두 그룹으로 나눌 때, <strong>난수표</strong>를 이용해 짝수 번호가 나온 환자는 수술군에, 홀수 번호가 나온 환자는 약물치료군에 배정하는 것과 같다. 이렇게 무작위로 배정하면, 마치 신의 관점에서 보았을 때 두 그룹이 완벽하게 균형을 이루게 된다.</p>
<p>예를 들어, 난수표를 통해 짝수 번호를 받아 <strong>수술군에 배정된 환자 5명(A, D, E, H, J)</strong>이 실제로 수술을 받았을 때 5명 모두 생존하여 생존율이 100%(<span class="math inline">\(1.0\)</span>)가 나왔다고 가정해 보자. 그리고 홀수 번호를 받아 <strong>약물치료군에 배정된 환자 5명(B, C, F, G, I)</strong>이 실제로 약물치료를 받았을 때 3명이 생존하여 생존율이 60%(<span class="math inline">\(0.6\)</span>)가 나왔다고 가정해 보자. 관찰된 결과의 차이는 <span class="math inline">\(1.0 - 0.6 = 0.4\)</span>이다.</p>
<p>여기서 핵심은 <strong>’만약’이라는 반사실적 상황</strong>이다. 교환가능성은 다음과 같이 설명한다.</p>
<ul>
<li><p><strong>수술군에 배정된 짝수 그룹(A, D, E, H, J)이 만약 약물치료를 받았다면 어땠을까(</strong><span class="math inline">\(E[Y(0) | T=1]\)</span>)? 무작위 배정 덕분에, 이 짝수 그룹의 잠재적 약물치료 결과는 <strong>실제로 약물치료를 받은 홀수 그룹(B, C, F, G, I)의 결과(</strong><span class="math inline">\(E[Y(0) | T=0]\)</span>)와 평균적으로 동일할 것이라고 가정할 수 있다. 즉, 짝수 그룹이 약물치료를 받았어도 홀수 그룹과 마찬가지로 5명 중 3명이 생존하여 평균 생존율이 60%(<span class="math inline">\(0.6\)</span>)였을 것이라는 뜻이다.</p></li>
<li>
<p><span class="math inline">\(E[Y(0) | T=1] = E[Y(0) | T=0]\)</span></p>
<ul>
<li>좌변 <span class="math inline">\(E[Y(0) | T=1]\)</span>은 <strong>수술군(</strong><span class="math inline">\(T=1\)</span>)이 만약 약물치료를 받았다면 어땠을까(<span class="math inline">\(Y(0)\)</span>)에 대한 평균 결과를 의미한다. 이는 수술군의 관찰 불가능한 ’반사실’이다.</li>
<li>우변 <span class="math inline">\(E[Y(0) | T=0]\)</span>은 <strong>실제로 약물치료군(</strong><span class="math inline">\(T=0\)</span>)에서 관찰된 평균 결과이다.</li>
<li>즉, ’교환가능성’이란 수술군의 반사실적 결과(만약 약물치료를 받았다면 어땠을지)가 약물치료군의 사실적 결과와 같을 것이라는 강력한 가정이며, 이는 오직 무작위 배정에 의해서만 정당화될 수 있다.</li>
</ul>
</li>
</ul>
<p>더 나아가, 교환가능성은 치료 배정 여부(<span class="math inline">\(T\)</span>)와 잠재적 결과(<span class="math inline">\(Y(1), Y(0)\)</span>)가 서로 독립적이라는 것을 의미하며, 이를 통계적 기호로 나타내면 다음과 같다.</p>
<p><span class="math display">\[(Y(1), Y(0)) \perp T\]</span></p>
<p>이 독립성(교환가능성) 가정 덕분에 우리는 관찰 불가능한 평균 인과 효과를 관찰 가능한 데이터로 추정할 수 있게 된다. 그 수학적 원리는 다음과 같다.</p>
<ol type="1">
<li>우리가 추정하고자 하는 목표는 <strong>ACE</strong> = <span class="math inline">\(E[Y(1) - Y(0)]\)</span> 이다.</li>
<li>기댓값의 선형성에 따라, 이는 <span class="math inline">\(E[Y(1)] - E[Y(0)]\)</span> 와 같다.</li>
<li>
<strong>무작위 배정(예: 난수표를 통한 짝수/홀수 배정)</strong>으로 인해 치료 배정 여부(<span class="math inline">\(T\)</span>)와 잠재적 결과(<span class="math inline">\(Y(1), Y(0)\)</span>)는 서로 독립적이 된다. 즉, <strong>교환가능성</strong>이 성립한다: <span class="math inline">\((Y(1), Y(0)) \perp T\)</span>
</li>
<li>이 독립성(교환가능성) 가정 덕분에, 우리는 잠재적 결과의 평균을 특정 집단에서 관찰된 결과의 평균으로 대체할 수 있다.
<ul>
<li>
<span class="math inline">\(E[Y(1)] = E[Y(1)|T=1] = E[Y|T=1]\)</span> (수술의 평균 잠재 효과는 수술군에서 관찰된 평균과 같다)</li>
<li>
<span class="math inline">\(E[Y(0)] = E[Y(0)|T=0] = E[Y|T=0]\)</span> (약물의 평균 잠재 효과는 약물군에서 관찰된 평균과 같다)</li>
</ul>
</li>
<li>따라서, 관찰이 불가능했던 목표치 <span class="math inline">\(E[Y(1)] - E[Y(0)]\)</span>는 관찰 가능한 두 집단의 평균 결과 차이, 즉 <span class="math inline">\(E[Y|T=1] - E[Y|T=0]\)</span> 로 계산될 수 있다.</li>
</ol>
<p>결론적으로, RCT를 통해 계산한 치료군과 대조군의 단순한 평균 결과 차이는 ’평균 인과 효과’의 편향되지 않은(unbiased) 추정치가 된다. 이처럼 RCT는 무작위 배정이라는 강력한 장치를 통해 측정되거나 측정되지 않은 모든 교란변수 문제를 원천적으로 해결하고 인과성을 명확하게 규명해주기 때문에, 인과추론 연구의 <strong>‘황금 표준(Gold Standard)’</strong>으로 간주된다.</p>
</section></section><section id="관찰-연구와-조건부-교환가능성" class="level2"><h2 class="anchored" data-anchor-id="관찰-연구와-조건부-교환가능성">3. 관찰 연구와 조건부 교환가능성</h2>
<p>앞서 RCT가 인과추론의 Gold Standard임을 확인했다. 하지만 모든 임상적 질문에 RCT를 적용하는 것은 현실적으로 불가능하거나 바람직하지 않을 때가 많다. <strong>윤리적 문제</strong>로 인해 효과가 입증된 치료를 환자에게 제공하지 않거나, 반대로 위험할 수 있는 시술에 무작위 배정할 수 없다. 수백, 수천억에 달할 수 있는 <strong>비용과 수년에 걸친 시간</strong>은 희귀 질환이나 장기적인 효과를 연구하는 데 큰 장벽이 된다. 또한, RCT는 참여 조건이 까다로워 실제 진료 현장의 다양하고 복잡한 환자군을 대표하지 못해 <strong>결과의 일반화 가능성이 떨어지는</strong> 한계도 있다.</p>
<p>이러한 이유들로 인해, 연구자들은 실제 진료 환경에서 자연스럽게 축적된 방대한 데이터, 즉 <strong>RWD(Real-World Data)를 활용한 관찰 연구</strong>에 눈을 돌리게 된다. 하지만 이와 동시에 우리는 RCT의 강력한 무기였던 ’무작위 배정’을 포기해야만 하며, 이는 <strong>선택 편향(selection bias)</strong>으로 인한 <strong>교란(confounding)</strong>이라는 새로운 문제에 직면하게 만든다.</p>
<p>관찰 연구에서 치료법의 선택은 연구자의 개입 없이 환자 및 임상의의 특성에 따라 자연스럽게 결정된다. 예를 들어, 특정 질환에 대해 고령의 환자는 수술의 위험 부담으로 인해 약물치료를, 상대적으로 건강한 젊은 환자는 수술을 선택하는 경향이 있을 수 있다. 이 경우, ’수술군’은 평균 연령이 낮고, ’약물치료군’은 평균 연령이 높은 두 집단이 만들어진다.</p>
<p>여기서 ’나이’는 치료법 선택(고령일수록 약물치료 선호)과 결과(고령일수록 사망 위험 높음) 모두에 영향을 미치므로 <strong>교란변수(confounder)</strong>로 작용한다. 만약 두 그룹의 사망률을 단순 비교한다면, 약물치료 그룹의 사망률이 더 높게 나타날 것이다. 하지만 이 결과는 약물치료가 덜 효과적이라서가 아니라, 단지 약물치료 그룹에 나이가 많아 사망 위험이 원래 높았던 환자들이 몰려있기 때문에 발생하는 편향일 수 있다. 즉, 치료법의 효과와 나이의 효과가 뒤섞여 나타나는 것이다.</p>
<p>RCT와 달리 관찰 연구에서는 치료군과 대조군이 비교 가능하지 않은, 즉 <strong>교환가능하지 않은(non-exchangeable)</strong> 상태에서 출발한다. 이처럼 ’나이’라는 교란변수 때문에 발생하는 편향을 극복하고 공정한 비교를 하기 위해, 우리는 <strong>조건부 교환가능성(Conditional Exchangeability)</strong>이라는 핵심적인 가정을 만족시켜야 한다.</p>
<p>조건부 교환가능성이란, <strong>‘비교를 왜곡하는 교란변수(X)의 값을 동일하게 고정하고 그 조건 안을 들여다보면, 두 그룹이 비로소 공정하게 비교 가능해진다’</strong>는 핵심 아이디어이다.</p>
<p>가장 직관적인 예시는 ‘나이’를 기준으로 생각해보는 것이다. 전체 환자를 비교하는 대신, <strong>오직 75세 환자들만</strong>을 모아 그 안에서 수술받은 사람과 약물치료받은 사람의 결과를 비교한다면, 적어도 ’나이’로 인한 편향은 사라진다. 이 ’나이(<span class="math inline">\(X\)</span>)를 75세로 고정하는(<span class="math inline">\(\mid X=75\)</span>)’ 조건 하에서는 치료 선택(<span class="math inline">\(T\)</span>)이 환자의 잠재적 결과(<span class="math inline">\(Y(0), Y(1)\)</span>)와 무관해질 것이라고 가정하는 것이 바로 조건부 교환가능성이다.</p>
<p>이 개념은 아래의 통계 기호로 명확하게 표현된다.</p>
<p><span class="math display">\[(Y(0), Y(1)) \perp T \mid X\]</span></p>
<p>이는 <strong>’교란변수</strong> <span class="math inline">\(X\)</span>(예: 나이)의 값을 고정하면, 잠재적 결과는 실제 받은 치료와 독립적이다’라는 우리가 통계적으로 달성하고자 하는 이상적인 상태를 의미한다.</p>
<p>그렇다면 이 이상적인 상태를 현실의 데이터로 어떻게 구현할 수 있을까? 바로 이 질문에 답하기 위해, ’나이’의 효과를 통제하는 다양한 통계적 방법론들이 고안되었다. 이 글에서는 그 중 하나인 회귀 분석(Regression)의 예시를 알아보겠다.</p>
<section id="r-교란-효과-시뮬레이션" class="level3"><h3 class="anchored" data-anchor-id="r-교란-효과-시뮬레이션">R: 교란 효과 시뮬레이션</h3>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com">data.table</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jinseob2kim/jstable">jstable</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">2025</span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">10000</span></span>
<span><span class="va">age</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">40</span>, <span class="fl">80</span><span class="op">)</span></span>
<span><span class="va">prob_med</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="op">(</span><span class="fl">0.1</span> <span class="op">*</span> <span class="op">(</span><span class="va">age</span> <span class="op">-</span> <span class="fl">60</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">treatment</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">1</span>, <span class="va">prob_med</span><span class="op">)</span></span>
<span><span class="va">treatment_fct</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">treatment</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Surgery"</span>, <span class="st">"Medication"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">prob_death</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="op">(</span><span class="op">-</span><span class="fl">6</span> <span class="op">+</span> <span class="fl">0.08</span> <span class="op">*</span> <span class="va">age</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">outcome_death</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">1</span>, <span class="va">prob_death</span><span class="op">)</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span></span>
<span>  age <span class="op">=</span> <span class="va">age</span>,</span>
<span>  treatment <span class="op">=</span> <span class="va">treatment_fct</span>,</span>
<span>  death <span class="op">=</span> <span class="va">outcome_death</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"--- Descriptive Statistics by Group ---\n"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--- Descriptive Statistics by Group ---</code></pre>
</div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">treatment</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span></span>
<span>    N <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    mean_age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">age</span><span class="op">)</span>,</span>
<span>    death_rate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">death</span><span class="op">)</span></span>
<span>  <span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 4
  treatment      N mean_age death_rate
  &lt;fct&gt;      &lt;int&gt;    &lt;dbl&gt;      &lt;dbl&gt;
1 Surgery     4977     54.4      0.192
2 Medication  5023     65.5      0.347</code></pre>
</div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_crude</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span><span class="va">death</span> <span class="op">~</span> <span class="va">treatment</span>, data <span class="op">=</span> <span class="va">df</span>, family <span class="op">=</span> <span class="st">"binomial"</span><span class="op">)</span></span>
<span><span class="va">model_adjusted</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span><span class="va">death</span> <span class="op">~</span> <span class="va">treatment</span> <span class="op">+</span> <span class="va">age</span>, data <span class="op">=</span> <span class="va">df</span>, family <span class="op">=</span> <span class="st">"binomial"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/jstable/man/glmshow.display.html">glmshow.display</a></span><span class="op">(</span><span class="va">model_crude</span><span class="op">)</span><span class="op">$</span><span class="va">table</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                 OR.(95%CI)         P value  
treatment: Medication vs Surgery "2.24 (2.04,2.45)" "&lt; 0.001"</code></pre>
</div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/jstable/man/glmshow.display.html">glmshow.display</a></span><span class="op">(</span><span class="va">model_adjusted</span><span class="op">)</span><span class="op">$</span><span class="va">table</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                 crude OR.(95%CI)   crude P value
treatment: Medication vs Surgery "2.24 (2.04,2.45)" "&lt; 0.001"    
age                              "1.08 (1.07,1.08)" "&lt; 0.001"    
                                 adj. OR.(95%CI)    adj. P value
treatment: Medication vs Surgery "1.05 (0.95,1.17)" "0.356"     
age                              "1.08 (1.07,1.08)" "&lt; 0.001"   </code></pre>
</div>
</div>
<p>시뮬레이션 데이터의 그룹별 특성을 먼저 살펴보면, 약물치료 그룹의 평균 연령(약 65세)이 수술 그룹(약 55세)보다 약 10세 더 높고, 그에 따라 사망률 역시 현저히 높은 것을 확인할 수 있다. 이 데이터만으로 로지스틱 회귀 분석을 수행했을 때, 수술 대비 약물치료의 오즈비는 2.24로 높게 나타난다는 것을 알 수 있다. 95% 신뢰구간이 1을 훌쩍 넘어서므로, 이 결과만 보면 약물치료가 통계적으로 유의하게 사망 위험을 2배 이상 높이는 것처럼 해석된다. 하지만 이것은 ‘나이’라는 교란변수가 만들어낸 결과라는 것을 알 수 있다. 모델에 ’나이’ 변수를 추가하여 그 효과를 통계적으로 보정한 결과, <strong>나이-보정 오즈비(Age-Adjusted Odds Ratio)는 1.05 (95% 신뢰구간: 0.95 - 1.17)</strong>로 극적으로 감소한다. 이는 통계적으로 두 치료법 간에 유의미한 사망 위험 차이가 없다는 뜻이며, ’두 치료법의 실제 효과는 동일하다’는 우리가 시뮬레이션에 설정한 진실을 정확하게 반영한다. 이처럼 교란변수 보정은 잘못된 결론을 바로잡고, 신뢰구간과 함께 결과의 불확실성을 평가함으로써 우리가 더 진실에 가까운 인과적 추론을 하도록 돕는다는 것을 알 수 있다. 이 외에도 교란변수에 대응하기 위한 다양한 통계방법들이 있다. 이는 추후 작성할 글에서 보다 자세히 알아보겠다.</p>
</section></section><section id="미측정-교란변수의-한계" class="level2"><h2 class="anchored" data-anchor-id="미측정-교란변수의-한계">4. 미측정 교란변수의 한계</h2>
<p>’나이’처럼 우리가 측정할 수 있는 교란변수 X를 모두 통계적으로 보정했다 하더라도, 관찰 연구의 문제는 끝나지 않는다. 바로 <strong>미측정 교란변수(unmeasured confounders)</strong>의 존재 가능성이다.</p>
<p>예를 들어, 환자의 <strong>‘가정 환경 및 사회경제적 수준(SES)’</strong>이라는 변수가 있다고 가정해보자. 이 변수는 보통 병원의 데이터베이스에는 기록되지 않아 측정하기 어렵다. 하지만 SES는 다음과 같이 치료 선택과 결과 모두에 영향을 미칠 수 있다.</p>
<p>SES와 치료 선택: 경제적으로 어려운 환자는 수술 후 회복 기간 동안 일을 쉬기 어려워, 회복이 빠른 약물치료를 선호할 수 있다.</p>
<p>SES와 결과: 낮은 SES는 평소 영양 상태나 건강 정보에 대한 접근성이 낮아 기저 건강 상태가 좋지 않을 수 있으며, 이는 치료법과 무관하게 사망 위험을 높일 수 있다.</p>
<p>이 경우 SES는 ’나이’와 마찬가지로 교란변수 역할을 하지만, 데이터에 없기 때문에 우리는 ’SES가 낮은 그룹’으로 조건을 걸어 비교하는 것이 불가능하다. 결국 SES로 인한 편향이 제거되지 않은 채 결과에 반영되고, 연구자는 SES의 효과를 약물치료의 효과로 잘못 해석할 위험에 처한다.</p>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com">data.table</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jinseob2kim/jstable">jstable</a></span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">10000</span> </span>
<span><span class="va">age</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">40</span>, <span class="fl">80</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ses</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">1</span>, <span class="fl">0.5</span><span class="op">)</span></span>
<span></span>
<span><span class="va">prob_med</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="op">(</span><span class="fl">0.1</span> <span class="op">*</span> <span class="op">(</span><span class="va">age</span> <span class="op">-</span> <span class="fl">60</span><span class="op">)</span> <span class="op">-</span>  <span class="va">ses</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">treatment</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">1</span>, <span class="va">prob_med</span><span class="op">)</span></span>
<span><span class="va">treatment_fct</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">treatment</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Surgery"</span>, <span class="st">"Medication"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">prob_death</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="op">(</span><span class="op">-</span><span class="fl">6</span> <span class="op">+</span> <span class="fl">0.08</span> <span class="op">*</span> <span class="va">age</span> <span class="op">-</span> <span class="fl">0.7</span> <span class="op">*</span> <span class="va">ses</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">outcome_death</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">1</span>, <span class="va">prob_death</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span></span>
<span>  age <span class="op">=</span> <span class="va">age</span>,</span>
<span>  ses <span class="op">=</span> <span class="va">ses</span>, </span>
<span>  treatment <span class="op">=</span> <span class="va">treatment_fct</span>,</span>
<span>  death <span class="op">=</span> <span class="va">outcome_death</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_crude</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span><span class="va">death</span> <span class="op">~</span> <span class="va">treatment</span>, data <span class="op">=</span> <span class="va">df</span>, family <span class="op">=</span> <span class="st">"binomial"</span><span class="op">)</span></span>
<span><span class="va">model_adjusted_age_only</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span><span class="va">death</span> <span class="op">~</span> <span class="va">treatment</span> <span class="op">+</span> <span class="va">age</span>, data <span class="op">=</span> <span class="va">df</span>, family <span class="op">=</span> <span class="st">"binomial"</span><span class="op">)</span></span>
<span><span class="va">model_fully_adjusted</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span><span class="va">death</span> <span class="op">~</span> <span class="va">treatment</span> <span class="op">+</span> <span class="va">age</span> <span class="op">+</span> <span class="va">ses</span>, data <span class="op">=</span> <span class="va">df</span>, family <span class="op">=</span> <span class="st">"binomial"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/jstable/man/glmshow.display.html">glmshow.display</a></span><span class="op">(</span><span class="va">model_crude</span><span class="op">)</span><span class="op">$</span><span class="va">table</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                 OR.(95%CI)         P value  
treatment: Medication vs Surgery "2.31 (2.09,2.55)" "&lt; 0.001"</code></pre>
</div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/jstable/man/glmshow.display.html">glmshow.display</a></span><span class="op">(</span><span class="va">model_adjusted_age_only</span><span class="op">)</span><span class="op">$</span><span class="va">table</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                 crude OR.(95%CI)   crude P value
treatment: Medication vs Surgery "2.31 (2.09,2.55)" "&lt; 0.001"    
age                              "1.08 (1.08,1.09)" "&lt; 0.001"    
                                 adj. OR.(95%CI)    adj. P value
treatment: Medication vs Surgery "1.13 (1.01,1.26)" "0.034"     
age                              "1.08 (1.08,1.09)" "&lt; 0.001"   </code></pre>
</div>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/jstable/man/glmshow.display.html">glmshow.display</a></span><span class="op">(</span><span class="va">model_fully_adjusted</span><span class="op">)</span><span class="op">$</span><span class="va">table</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                 crude OR.(95%CI)   crude P value
treatment: Medication vs Surgery "2.31 (2.09,2.55)" "&lt; 0.001"    
age                              "1.08 (1.08,1.09)" "&lt; 0.001"    
ses                              "0.55 (0.5,0.61)"  "&lt; 0.001"    
                                 adj. OR.(95%CI)    adj. P value
treatment: Medication vs Surgery "0.96 (0.85,1.08)" "0.461"     
age                              "1.09 (1.08,1.09)" "&lt; 0.001"   
ses                              "0.5 (0.45,0.56)"  "&lt; 0.001"   </code></pre>
</div>
</div>
<p>이번 시뮬레이션에서는 우리가 측정할 수 없는 교란변수 ’SES’가 존재할 때 어떤 일이 발생하는지 보여준다. 이 데이터는 ’낮은 SES’가 약물치료 선택 확률과 사망 확률을 모두 높이도록, 하지만 치료법 자체의 실제 효과는 없도록(True OR = 1.0) 설계되었다.시뮬레이션 결과에서 살펴볼수 있듯이, ses라는 변수를 우리가 모르는 경우에 나이라는 알고 있는 변수를 보정하더라도 오즈비를 1.13으로 해석하여 위험비를 실제 값인 1과 다르게 해석하여 통계적으로 유의미하게 잘못된 결론을 내리게 된다는 것을 알 수 있다. 따라서 우리가 아는 교란변수를 정교하게 보정하더라도, <strong>데이터에 없는 중요한 교란변수가 있는 경우 추정치가 진실에서 벗어난 편향된 값</strong>을 갖게 된다는 것을 알 수 있다.</p>
<p>이것이 관찰 연구의 근본적인 한계이며, RCT가 Gold Standard인 이유이다. RCT에서는 무작위 배정을 통해 부유한 사람이든, 어려운 환경의 사람이든 모두가 수술군과 약물군에 확률적으로 고르게 분포하게 된다. 따라서 RCT는 우리가 사전에 인지하고 측정한 변수뿐만 아니라, 인지하지 못했거나 측정하지 못한 미지의 교란변수(SES, 유전적 특성, 성격 등)까지도 통계적으로 통제해준다. 하지만 RWD를 활용하는 관찰 연구에서는 이러한 완벽한 보장을 할 수 없으므로, 알려진 교란변수를 최대한 보정하여 최선의 추정치를 찾아내고자 노력하는 것이다.</p>
</section><section id="시간축관련-편향-time-related-biases" class="level2"><h2 class="anchored" data-anchor-id="시간축관련-편향-time-related-biases">5. 시간축관련 편향 (Time-related Biases)</h2>
<p>지금까지 우리는 ’누구를 비교할 것인가’에 대한 문제, 즉 <strong>교란(Confounding)</strong>에 대해 집중적으로 살펴보았다. 이는 RWD 인과추론의 가장 중요하고 핵심적인 도전이다. 하지만 RWD 연구의 복잡성은 여기서 그치지 않는다. 교란만큼이나 치명적일 수 있는 두 번째 도전 과제가 남아있기 때문이다. 바로 “언제부터를 연구의 시작점(Time-zero)으로 볼 것인가?” 라는 시간축 설정의 문제이다.</p>
<p>RCT에서는 모든 것이 명확하다. 환자가 연구에 동의하고 무작위 배정되는 그 순간이 모든 추적 관찰의 시작점(Time-zero)이 된다. 환자 등록(Eligibility, E), 연구 시작(Time-zero, T0), 치료 배정(Assignment, A)이 한 지점에서 동시에 일어난다. 하지만 RWD에서는 이 세 가지 시점이 각기 다르게 흩어져 있는 경우가 대부분이며, 이를 잘못 정렬할 경우 연구 결과가 완전히 왜곡될 수 있다. 실제 유명 연구 사례와 간단한 시뮬레이션을 통해 그 위험성을 살펴보자.</p>
</section><section id="immortal-time-bias와-healthy-user-bias" class="level2"><h2 class="anchored" data-anchor-id="immortal-time-bias와-healthy-user-bias">5.1 Immortal Time Bias와 Healthy User Bias</h2>
<p>앞서 우리는 교란(Confounding)이라는, ’비교 대상’이 다른 문제에 대해 알아보았다. 하지만 RWD 연구에는 또 다른 큰 축의 도전 과제가 존재한다. 바로 ’비교 시점’이 다른, 시간축 설정의 문제이다.</p>
<p>RCT에서는 환자 등록(Eligibility, E), 연구 시작(Time-zero, T0), 치료 배정(Assignment, A)이 ’무작위 배정’이라는 한 시점에 동시에 일어난다 (<code>E = T0 = A</code>). 모든 참가자가 동일한 출발선에서 경주를 시작하는 셈이다. 하지만 RWD에서는 이 세 시점이 각기 다르게 흩어져 있는 경우가 대부분이며, 이를 잘못 정렬하면 연구 결과가 완전히 왜곡될 수 있다.</p>
<p>이때 발생하는 가장 대표적인 편향이 <strong>Immortal Time Bias</strong>와 <strong>Healthy User Bias</strong>이다. 이 둘은 다르지만, 매우 밀접하게 얽혀있다.</p>
<p>Healthy User Bias는 Confounding의 일종이다. 특정 치료법을 사용하는 사람들이 그렇지 않은 사람들에 비해, 원래부터 더 건강하거나 건강에 대한 관심이 많은 등 근본적인 차이가 있는 현상을 말한다. <strong>Immortal Time Bias</strong>는 이러한 편향을 유발하거나 증폭시키는 동시에 <strong>시간축 설정의 구조적 오류</strong>이다.</p>
<p>‘HRT(호르몬 대체 요법)’ 사례를 통해 이 둘의 관계를 살펴보자. 과거 여러 관찰 연구는 HRT가 심혈관 질환 위험을 크게 낮춘다(RR ≈ 0.6)고 보고했지만, 이후의 대규모 RCT(WHI Trial)에서는 오히려 위험을 약간 높인다(HR ≈ 1.2)는 상반된 결과를 보였다.</p>
<p>이러한 불일치의 핵심 기전이 바로 ’Immortal Time’이다. ’HRT 사용자’로 연구에 포함되려면, 한 여성은 폐경(E)을 겪은 후 HRT를 실제로 처방받는 시점(A)까지, 심혈관 질환 없이 <strong>반드시 생존해야만 한다.</strong> 이 <strong>생존이 조건이 되는 기간</strong>이 바로 Immortal Time이다.</p>
<p>이 생존 기간은 일종의 선별 과정으로 작용한다. 만약 질병의 위험이 초기에 가장 높다면, 이 기간 동안 상대적으로 허약한 사람들은 먼저 탈락(사건 발생)하고, 이 시기를 통과한 ‘강건한’ 생존자들만이 ‘HRT 사용자’ 그룹에 포함될 기회를 얻는다. 즉, <strong>Immortal Time이라는 구조적 장치가 ’건강한 사용자’를 인위적으로 선택해내는 편향을 유발</strong>하는 것이다.</p>
<section id="r-immortal-time-bias의-재현" class="level4"><h4 class="anchored" data-anchor-id="r-immortal-time-bias의-재현">R : Immortal time bias의 재현</h4>
<p>HRT의 실제 효과가 전혀 없다고(True HR = 1.0) 가정하고, 단지 ‘초기에 위험이 높은’ 상황에서 치료 시작 시점만 환자마다 다른 경우를 시뮬레이션한다. 이 시뮬레이션은 ’건강상태’라는 변수 없이도, 생존 자체가 어떻게 선택 편향을 유발하는지 보여준다.</p>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/therneau/survival">survival</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jinseob2kim/jstable">jstable</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">2025</span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">10000</span></span>
<span></span>
<span><span class="co"># 1. 가상의 치료군과 대조군을 1:1로 배정한다.</span></span>
<span><span class="va">group</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">1</span>, <span class="fl">0.5</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 2. '초기 위험'이 높은 Weibull 분포로 생존 시간을 생성한다.</span></span>
<span><span class="co">#    shape &lt; 1 은 초기에 사망 위험(hazard)이 가장 높고,</span></span>
<span><span class="co">#    시간이 지남에 따라 위험이 감소함을 의미한다.</span></span>
<span><span class="co">#    이는 '허약한' 개체가 초기에 탈락하는 상황을 모방한다.</span></span>
<span><span class="co">#    두 그룹의 근본적인 생존 분포는 완전히 동일하게 설정한다.</span></span>
<span><span class="va">death_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Weibull.html">rweibull</a></span><span class="op">(</span><span class="va">n</span>, shape <span class="op">=</span> <span class="fl">0.7</span>, scale <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 3. 치료군(group=1)에만 치료 시작 시간을 무작위로 부여한다.</span></span>
<span><span class="co">#    치료 시작은 위험이 높은 초기 구간(e.g., 0 ~ 2.5년) 내에서 이루어진다고 가정한다.</span></span>
<span><span class="va">tx_start_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">n</span><span class="op">)</span></span>
<span><span class="va">tx_start_time</span><span class="op">[</span><span class="va">group</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">group</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>, <span class="fl">0</span>, <span class="fl">2.5</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df_base</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span></span>
<span>  id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">n</span>,</span>
<span>  group_true <span class="op">=</span> <span class="va">group</span>,</span>
<span>  death_time <span class="op">=</span> <span class="va">death_time</span>,</span>
<span>  tx_start_time <span class="op">=</span> <span class="va">tx_start_time</span>,</span>
<span>  event <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 4. 잘못된 분석 데이터셋을 구축 (관찰 연구의 오류 재현)</span></span>
<span><span class="co"># 4-1. 대조군(Never-treated) 데이터: 처음부터 끝까지 치료 안 받음</span></span>
<span><span class="va">df_control</span> <span class="op">&lt;-</span> <span class="va">df_base</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">group_true</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>fup_time <span class="op">=</span> <span class="va">death_time</span>, group_obs <span class="op">=</span> <span class="st">"Control"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 4-2. 치료군(Treated) 데이터: '치료 시작 전 사망자'는 애초에 치료군이 될 수 없으므로 제외</span></span>
<span><span class="va">df_treated_biased</span> <span class="op">&lt;-</span> <span class="va">df_base</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">group_true</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># 오류 (a): Immortal Time 동안의 사망자 제외 (선택 편향 발생)</span></span>
<span>  <span class="co"># 즉, 치료 시작 전에 사망한 환자는 '치료군'에 포함될 수 없다.</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">death_time</span> <span class="op">&gt;=</span> <span class="va">tx_start_time</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># 오류 (b): 치료 시작 시점을 새로운 Time-zero로 설정</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>fup_time <span class="op">=</span> <span class="va">death_time</span> <span class="op">-</span> <span class="va">tx_start_time</span>, group_obs <span class="op">=</span> <span class="st">"Treatment"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 4-3. 두 데이터셋을 합쳐 최종 분석 데이터셋 생성</span></span>
<span><span class="va">df_final_biased</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span></span>
<span>  <span class="va">df_control</span>,</span>
<span>  <span class="va">df_treated_biased</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 5. 편향이 발생한 모델</span></span>
<span><span class="va">biased_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">fup_time</span>, <span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">group_obs</span>, data <span class="op">=</span> <span class="va">df_final_biased</span>, model <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"--- Biased Analysis with Immortal Time ---\n"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--- Biased Analysis with Immortal Time ---</code></pre>
</div>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/jstable/man/cox2.display.html">cox2.display</a></span><span class="op">(</span><span class="va">biased_model</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$table
                   HR(95%CI)          P value  
group_obsTreatment "0.87 (0.84,0.91)" "&lt; 0.001"

$metric
                    [,1]               [,2]
&lt;NA&gt;                NA                 NA  
No. of observations "9009"             NA  
No. of events       "9009"             NA  
AIC                 "146024.260755666" NA  
C-Index             "0.525(0.003)"     NA  

$caption
[1] "Cox model on time ('fup_time') to event ('event')"</code></pre>
</div>
</div>
<p>코드 해석: 이 시뮬레이션에서 치료의 실제 효과는 전혀 없도록(True HR=1.0) 설계되었다. 하지만 실제 관찰 연구에서 흔히 저지르는 오류, 즉 ‘치료 시작 전에 사망한 사람을 제외’하고 ’치료 시작 시점부터 시간을 재는’ 방식으로 데이터를 분석한 결과, 치료군의 사망 위험이 대조군에 비해 13%나 낮은 것처럼 보이는(HR ≈ 0.87) 편향이 발생했다.</p>
<p>이 결과는 치료가 효과적이어서가 아니라, 치료군에 포함된 사람들이 <strong>생존이 가장 어려운 ‘초기 위험 구간’을 통과한 ’선택된 생존자’</strong>들이기 때문에 나타난 착시이다. 이처럼 Immortal Time Bias는 시간축 설정 오류를 통해 연구 집단에 선택 편향을 유발하는, 교묘한 편향의 기전임을 알 수 있다</p>
</section></section><section id="prevalent-user-bias" class="level2"><h2 class="anchored" data-anchor-id="prevalent-user-bias">5.2 Prevalent User Bias</h2>
<p>스타틴의 심혈관 질환 예방 효과를 다룬 한 유명 관찰 연구에서는 스타틴이 사망 위험을 유의미하게 낮춘다(HR ≈ 0.85)고 보고했지만, 이 역시 여러 RCT의 메타분석 결과(HR ≈ 1.00)와는 상반된 결과였다.</p>
<p>이 편향의 핵심 원인은 연구 시작 시점에 이미 약물을 복용 중이던 <strong>‘기존 사용자(Prevalent User)’</strong>를 ’비사용자’와 비교했기 때문이다. 이는 <strong>생존 편향(Survivorship Bias)</strong>을 유발하는 대표적인 연구 설계 오류이다.</p>
<p>어떤 약물이든, 복용 초기에는 부작용이나 효과 부족으로 인해 복용을 중단하는 환자들이 발생한다. 특히 약물에 취약한 ‘민감한(susceptible)’ 환자들은 이 초기 단계에서 대부분 탈락할 가능성이 높다. 따라서, 오랜 기간 약물을 계속 복용하고 있는 ‘기존 사용자’들은 이 혹독한 초기 기간을 ’통과하고 살아남은’ 사람들이다. 이들은 약물에 잘 적응했거나, 원래부터 더 건강한 ‘강건한(robust)’ 환자들로 구성된 <strong>선택된(selected) 집단</strong>이다.</p>
<p>이러한 ‘선택된 생존자’ 그룹을 일반적인 ‘비사용자’ 그룹과 비교하면, 두 그룹의 기저 건강상태가 근본적으로 다르기 때문에(즉, 교환가능성이 깨져있기 때문에) 약물의 안전성이나 효과가 실제보다 과대평가될 수밖에 없다.</p>
<section id="r-기존-사용자-편향의-재현" class="level4"><h4 class="anchored" data-anchor-id="r-기존-사용자-편향의-재현">R : 기존 사용자 편향의 재현</h4>
<p>스타틴의 실제 효과는 전혀 없다고(True OR = 1.0) 가정하고, ‘민감한’ 환자들이 초기 사용 기간에 탈락하는 상황을 시뮬레이션하여 기존 사용자 그룹과 비사용자 그룹을 비교해 보자.</p>
<div class="cell">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">2025</span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">10000</span></span>
<span></span>
<span><span class="va">initial_users</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span></span>
<span>  id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">n</span>,</span>
<span>  susceptible <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">1</span>, <span class="fl">0.2</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 1년의 "Wash-in" 기간 동안의 탈락 시뮬레이션</span></span>
<span><span class="co"># 민감한 그룹은 50%가 탈락, 강건한 그룹은 5%만 탈락</span></span>
<span><span class="va">prob_dropout</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">initial_users</span><span class="op">$</span><span class="va">susceptible</span> <span class="op">==</span> <span class="fl">1</span>, <span class="fl">0.5</span>, <span class="fl">0.05</span><span class="op">)</span></span>
<span><span class="va">washin_survivor_status</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">1</span>, <span class="fl">1</span> <span class="op">-</span> <span class="va">prob_dropout</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 3. t=0 시점의 두 그룹 생성</span></span>
<span><span class="va">df_prevalent</span> <span class="op">&lt;-</span> <span class="va">initial_users</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">washin_survivor_status</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>treatment <span class="op">=</span> <span class="st">"Prevalent User"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df_non_user</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span></span>
<span>  id <span class="op">=</span> <span class="op">(</span><span class="va">n</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">n</span><span class="op">)</span>,</span>
<span>  susceptible <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">1</span>, <span class="fl">0.2</span><span class="op">)</span>, </span>
<span>  treatment <span class="op">=</span> <span class="st">"Non-User"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">df_final</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="va">df_prevalent</span>, <span class="va">df_non_user</span><span class="op">)</span></span>
<span></span>
<span><span class="va">prob_death</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">df_final</span><span class="op">$</span><span class="va">susceptible</span> <span class="op">==</span> <span class="fl">1</span>, <span class="fl">0.2</span>, <span class="fl">0.05</span><span class="op">)</span></span>
<span><span class="va">df_final</span><span class="op">$</span><span class="va">death</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">df_final</span><span class="op">)</span>, <span class="fl">1</span>, <span class="va">prob_death</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># --- 분석 ---</span></span>
<span><span class="co"># 1. 두 그룹 간 '민감한' 환자 비율 비교 (교란 확인)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"--- Proportion of Susceptible Individuals by Group ---\n"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--- Proportion of Susceptible Individuals by Group ---</code></pre>
</div>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df_final</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">treatment</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span></span>
<span>    n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    prop_susceptible <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">susceptible</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 3
  treatment          n prop_susceptible
  &lt;chr&gt;          &lt;int&gt;            &lt;dbl&gt;
1 Non-User       10000            0.199
2 Prevalent User  8588            0.120</code></pre>
</div>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 2. 로지스틱 회귀분석으로 오즈비 계산</span></span>
<span><span class="va">model_biased</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span><span class="va">death</span> <span class="op">~</span> <span class="va">treatment</span>, data <span class="op">=</span> <span class="va">df_final</span>, family <span class="op">=</span> <span class="st">"binomial"</span>, model <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/jstable/man/glmshow.display.html">glmshow.display</a></span><span class="op">(</span><span class="va">model_biased</span><span class="op">)</span><span class="op">$</span><span class="va">table</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                      OR.(95%CI)        P value  
treatment: Prevalent User vs Non-User "0.78 (0.7,0.87)" "&lt; 0.001"</code></pre>
</div>
</div>
<p>코드 해석: 시뮬레이션의 첫 번째 결과는 두 그룹의 근본적인 차이를 명확히 보여준다. ‘비사용자’ 그룹은 설계대로 약 20%가 약물에 ‘민감한’ 환자로 구성된 반면, 초기 탈락 과정을 거친 ‘기존 사용자’ 그룹에는 ‘민감한’ 환자가 약 12%밖에 남지 않았다. 이미 출발선부터 다른, 즉 교환 가능하지 않은 두 그룹이 만들어진 것이다.</p>
<p>이러한 근본적인 차이는 회귀 분석 결과에 그대로 반영된다. ‘기존 사용자’ 그룹은 ‘비사용자’ 그룹에 비해 사망에 대한 오즈비(Odds Ratio)가 약 0.78으로, 사망 위험이 20% 가량 낮은 것처럼 보이는 강력한 보호 효과를 나타낸다.</p>
<p>하지만 우리는 이 약의 실제 효과가 없다는 것을 알고 있다. 이 결과는 약효 때문이 아니라, 단지 건강하고 강건한 ‘생존자’ 그룹을, 일반적인 위험도를 가진 그룹과 비교했기 때문에 발생한 통계적 착시일 뿐이다. 이는 ’기존 사용자’를 포함하는 연구 디자인의 위험성과, 비교 대상을 신중하게 선택해야 하는 이유를 명확하게 보여준다. 이러한 문제를 해결하기 위해 RWD 연구에서는 약물을 처음 사용하는 시점의 환자들만을 비교하는 <strong>‘신규 사용자 설계(New-user Design)’</strong>가 표준적인 방법으로 권장된다.</p>
</section></section><section id="결론" class="level2"><h2 class="anchored" data-anchor-id="결론">6 결론</h2>
<p>RWD를 이용한 인과추론에서 <strong>교란(Confounding)</strong>의 문제와 <strong>시간축 설정(Time-related biases)</strong>의 문제에 대해서 알아보았다. 우리는 시뮬레이션을 통해, <strong>관찰되지 않은 교란변수(Unmeasured Confounder)</strong>가 존재하거나, RWD의 본질적인 시간축 불일치 문제(Immortal Time, Prevalent User Bias)가 있을 때, 우리가 데이터에서 단순하게 관찰한 연관성(association)은 우리가 알고자 하는 <strong>참된 인과적 효과(true causal effect)</strong>와 크게 다를 수 있음을 확인했다. 이는 관찰 연구가 가진 명백하고 본질적인 한계이다. 하지만 이러한 한계를 인지하는 것이 바로 인과추론의 진정한 시작점이다. 통계학자들과 역학자들은 ’이러한 편향이 존재함을 안다면, 그 편향의 크기를 줄여 <strong>편향된 추정치(biased estimate)</strong>를 참값에 최대한 가깝게 만들 수 있지 않을까?’라는 질문에 답하기 위해 수많은 방법론을 발전시켜왔다. 앞으로 이어질 글 들에서는 해당 방법들을 보다 자세히 탐구하도록 하겠다.</p>


</section><div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{jo2025,
  author = {Jo, Hyungwoo},
  title = {Causal {Inference} (1)},
  date = {2025-06-27},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-jo2025" class="csl-entry quarto-appendix-citeas" role="listitem">
Jo, Hyungwoo. 2025. <span>“Causal Inference (1).”</span> June 27, 2025.
</div></div></section></div></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



<script src="../../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>